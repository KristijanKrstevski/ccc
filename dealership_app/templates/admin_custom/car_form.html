{% extends "admin_custom/base_admin.html" %}
{% block title %}{% if car %}Edit Vehicle{% else %}Add New Vehicle{% endif %} - AUTO DINERO Admin{% endblock %}

{% block extra_css %}
<style>
    .form-section {
        background: var(--white);
        padding: 30px;
        border-radius: 16px;
        box-shadow: var(--shadow);
        margin-bottom: 25px;
        border: 1px solid rgba(255, 140, 0, 0.1);
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .form-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--gradient);
    }
    
    .form-section:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-hover);
    }
    
    .form-section h5 {
        font-family: 'Poppins', sans-serif;
        font-weight: 600;
        color: var(--dark-gray);
        margin-bottom: 20px;
        font-size: 1.3rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .form-section h5 i {
        color: var(--primary-red);
        font-size: 1.4rem;
    }
    
    /* Enhanced Form Controls */
    .form-control, .form-select {
        border: 2px solid rgba(255, 140, 0, 0.1) !important;
        border-radius: 12px !important;
        padding: 15px 18px !important;
        font-size: 1rem !important;
        font-weight: 500 !important;
        transition: all 0.3s ease !important;
        background: rgba(255, 255, 255, 0.8) !important;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: var(--primary-red) !important;
        box-shadow: 0 0 0 0.2rem rgba(255, 140, 0, 0.15) !important;
        background: var(--white) !important;
        transform: scale(1.02) !important;
    }
    
    .form-label {
        font-weight: 600 !important;
        color: var(--dark-gray) !important;
        margin-bottom: 8px !important;
        font-size: 0.95rem !important;
        text-transform: uppercase !important;
        letter-spacing: 0.5px !important;
    }
    
    textarea.form-control {
        min-height: 120px !important;
        resize: vertical !important;
    }
    
    /* Image Preview Enhanced */
    .img-preview {
        width: 150px;
        height: 100px;
        object-fit: contain;
        border-radius: 12px;
        border: 3px solid rgba(255, 140, 0, 0.1);
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .img-preview:hover {
        transform: scale(1.05);
        border-color: var(--primary-red);
        box-shadow: var(--shadow);
    }
    
    /* Enhanced Dual List Equipment */
    .dual-list {
        display: flex;
        justify-content: space-between;
        gap: 20px;
        align-items: stretch;
    }
    
    .dual-list-column {
        flex: 1;
        background: rgba(255, 255, 255, 0.5);
        border-radius: 12px;
        padding: 20px;
        border: 2px solid rgba(255, 140, 0, 0.1);
    }
    
    .dual-list-header {
        font-weight: 600;
        color: var(--dark-gray);
        margin-bottom: 15px;
        text-align: center;
        font-size: 1.1rem;
    }
    
    .dual-list select {
        width: 100% !important;
        min-height: 300px !important;
        border: 2px solid rgba(255, 140, 0, 0.1) !important;
        border-radius: 12px !important;
        padding: 15px !important;
        font-size: 1rem !important;
        background: var(--white) !important;
    }
    
    .dual-list option {
        padding: 12px 8px !important;
        font-size: 1rem !important;
        border-radius: 6px !important;
        margin-bottom: 2px !important;
    }
    
    .dual-list option:hover {
        background: rgba(255, 140, 0, 0.1) !important;
    }
    
    .dual-list-buttons {
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 10px;
        min-width: 80px;
    }
    
    .dual-list-buttons .btn {
        border-radius: 50% !important;
        width: 50px !important;
        height: 50px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        font-weight: bold !important;
        font-size: 1.2rem !important;
        transition: all 0.3s ease !important;
    }
    
    .dual-list-buttons .btn:hover {
        transform: scale(1.1) !important;
        box-shadow: var(--shadow) !important;
    }
    
    /* Image Gallery Enhanced */
    .image-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .image-item {
        position: relative;
        background: var(--white);
        border-radius: 12px;
        padding: 15px;
        box-shadow: var(--shadow);
        transition: all 0.3s ease;
        border: 2px solid rgba(255, 140, 0, 0.1);
        cursor: move;
        user-select: none;
    }
    
    .image-item:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-hover);
    }
    
    .image-item.sortable-ghost {
        opacity: 0.5;
        transform: rotate(5deg);
    }
    
    .image-item.sortable-drag {
        opacity: 0.8;
        transform: rotate(5deg) scale(1.05);
        z-index: 9999;
    }
    
    .image-item img {
        width: 100%;
        height: 120px;
        object-fit: contain;
        border-radius: 8px;
        margin-bottom: 10px;
        pointer-events: none;
    }
    
    .image-position-badge {
        position: absolute;
        top: 8px;
        left: 8px;
        background: var(--gradient);
        color: var(--white);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.9rem;
        z-index: 2;
        box-shadow: var(--shadow);
    }
    
    .drag-handle {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(0, 0, 0, 0.7);
        color: var(--white);
        border-radius: 6px;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        cursor: grab;
        z-index: 2;
        transition: all 0.3s ease;
    }
    
    .drag-handle:hover {
        background: rgba(0, 0, 0, 0.9);
        transform: scale(1.1);
    }
    
    .delete-image-btn {
        width: 100% !important;
        border-radius: 8px !important;
        font-weight: 600 !important;
        transition: all 0.3s ease !important;
        pointer-events: all !important;
    }
    
    .delete-image-btn:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4) !important;
    }
    
    /* Add Equipment Section */
    .add-equipment-section {
        background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(32, 201, 151, 0.1));
        border: 2px solid rgba(40, 167, 69, 0.2);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
    }
    
    .add-equipment-form {
        display: flex;
        align-items: end;
        gap: 15px;
    }
    
    .equipment-input-group {
        flex: 1;
    }
    
    .btn-add-equipment {
        background: linear-gradient(135deg, #28a745, #20c997) !important;
        border: none !important;
        border-radius: 12px !important;
        padding: 15px 25px !important;
        font-weight: 600 !important;
        color: var(--white) !important;
        transition: all 0.3s ease !important;
        display: flex !important;
        align-items: center !important;
        gap: 8px !important;
        min-width: 140px !important;
        justify-content: center !important;
        height: 58px !important; /* Match input height */
    }
    
    .btn-add-equipment:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 6px 25px rgba(40, 167, 69, 0.4) !important;
        color: var(--white) !important;
    }
    
    .btn-add-equipment:disabled {
        opacity: 0.6 !important;
        transform: none !important;
        cursor: not-allowed !important;
    }
    
    .btn-add-equipment.loading {
        position: relative;
    }
    
    .btn-add-equipment.loading::after {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255,255,255,.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
        right: 15px;
    }

    /* Checkbox Enhancement */
    .form-check {
        background: rgba(255, 140, 0, 0.05);
        padding: 15px 20px;
        border-radius: 12px;
        border: 2px solid rgba(255, 140, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 15px;
        transition: all 0.3s ease;
    }
    
    .form-check:hover {
        background: rgba(255, 140, 0, 0.1);
        border-color: var(--primary-red);
    }
    
    .form-check-input {
        width: 20px !important;
        height: 20px !important;
        border-radius: 4px !important;
        border: 2px solid var(--primary-red) !important;
    }
    
    .form-check-input:checked {
        background-color: var(--primary-red) !important;
        border-color: var(--primary-red) !important;
    }
    
    .form-check-label {
        font-weight: 600 !important;
        color: var(--dark-gray) !important;
        font-size: 1.1rem !important;
    }
    
    /* Action Buttons */
    .action-buttons {
        background: var(--white);
        padding: 25px;
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid rgba(255, 140, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 20px;
    }
    
    .btn-save {
        background: var(--gradient) !important;
        border: none !important;
        border-radius: 12px !important;
        padding: 15px 30px !important;
        font-weight: 600 !important;
        font-size: 1.1rem !important;
        color: var(--white) !important;
        transition: all 0.3s ease !important;
        display: flex !important;
        align-items: center !important;
        gap: 10px !important;
        min-width: 200px !important;
        justify-content: center !important;
    }
    
    .btn-save:hover {
        transform: translateY(-3px) !important;
        box-shadow: var(--shadow-hover) !important;
        color: var(--white) !important;
    }
    
    .btn-back {
        background: var(--medium-gray) !important;
        border: none !important;
        border-radius: 12px !important;
        padding: 15px 25px !important;
        font-weight: 600 !important;
        color: var(--white) !important;
        transition: all 0.3s ease !important;
        text-decoration: none !important;
        display: flex !important;
        align-items: center !important;
        gap: 10px !important;
    }
    
    .btn-back:hover {
        transform: translateY(-2px) !important;
        box-shadow: var(--shadow) !important;
        color: var(--white) !important;
        text-decoration: none !important;
    }
    
    /* Add new car button styling */
    .btn-success {
        background: linear-gradient(135deg, #28a745, #20c997) !important;
        border: none !important;
        border-radius: 12px !important;
        padding: 12px 24px !important;
        font-weight: 600 !important;
        transition: all 0.3s ease !important;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3) !important;
    }
    
    .btn-success:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 6px 25px rgba(40, 167, 69, 0.4) !important;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
        .page-header .d-flex {
            flex-direction: column;
            align-items: stretch;
            gap: 15px;
        }
        
        .page-header .btn-success {
            width: 100%;
            text-align: center;
        }
        
        .dual-list {
            flex-direction: column;
            gap: 15px;
        }
        
        .dual-list-buttons {
            flex-direction: row;
            justify-content: center;
        }
        
        .action-buttons {
            flex-direction: column;
        }
        
        .btn-save, .btn-back {
            width: 100% !important;
        }
        
        .form-section {
            padding: 20px;
        }
    }
    
    /* Field Error Styles */
    .field-error {
        background: #fff5f5 !important;
        border-color: #e53e3e !important;
        box-shadow: 0 0 0 0.2rem rgba(229, 62, 62, 0.15) !important;
    }
    
    .text-danger {
        color: #e53e3e !important;
        font-weight: 500 !important;
    }
    
    .text-danger i {
        margin-right: 5px;
    }
    
    /* Banner Selection Styles */
    .banner-selection {
        margin-top: 15px;
    }
    
    .banner-radio {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .banner-radio label {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        border: 2px solid #ddd;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #f8f9fa;
        font-weight: 500;
    }
    
    .banner-radio input[type="radio"] {
        margin-right: 10px;
        transform: scale(1.3);
        accent-color: #007bff;
    }
    
    .banner-radio label:hover {
        border-color: #007bff;
        background: #e3f2fd;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,123,255,0.15);
    }
    
    .banner-radio input[type="radio"]:checked + label {
        border-color: #007bff;
        background: #007bff;
        color: white;
        font-weight: bold;
        box-shadow: 0 4px 12px rgba(0,123,255,0.3);
    }

    /* Badge Selection Styles */
    .badge-selection {
        margin-top: 15px;
    }

    .badge-option {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 15px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        transition: all 0.3s ease;
        cursor: pointer;
        background: #f8f9fa;
    }

    .badge-option:hover {
        border-color: #007bff;
        background: #e3f2fd;
        transform: translateY(-1px);
        box-shadow: 0 3px 10px rgba(0,123,255,0.1);
    }

    .badge-option input[type="checkbox"] {
        transform: scale(1.2);
        accent-color: #007bff;
    }

    .badge-option input[type="checkbox"]:checked + .badge-label {
        .badge-preview {
            opacity: 1;
            transform: scale(1.1);
        }
    }

    .badge-label {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        flex: 1;
    }

    .badge-preview {
        opacity: 0.6;
        transition: all 0.3s ease;
    }

    .badge-text {
        font-size: 0.9rem;
        font-weight: 600;
        color: #495057;
    }

    /* Badge styles from your design */
    .badge-rect {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 110px;
        max-width: 180px;
        padding: 8px 14px;
        border-radius: 6px;
        font-weight: 800;
        font-size: 0.85rem;
        color: var(--white);
        box-shadow: 0 8px 18px rgba(12,16,28,0.08);
        text-transform: uppercase;
        letter-spacing: .05em;
        white-space: nowrap;
        overflow: hidden;
        position: relative;
    }

    .badge-registered {
        background: linear-gradient(180deg, #18b56a, #0f8a50);
        color: white;
    }

    .badge-serviced {
        background: linear-gradient(180deg, #ffd96a, #ffcf4d);
        color: #111;
        font-weight: 900;
    }

    .badge-promo {
        background: linear-gradient(180deg, #ff6b7a, #ff4757);
        color: white;
        clip-path: polygon(
            0% 6%,
            84% 6%,
            98% 18%,
            92% 30%,
            98% 44%,
            86% 56%,
            98% 74%,
            80% 84%,
            12% 84%,
            0% 70%,
            6% 54%,
            0% 34%
        );
        padding: 8px 12px;
        min-width: 92px;
        box-shadow: 0 10px 26px rgba(255,71,87,0.11), 0 3px 8px rgba(0,0,0,0.05) inset;
    }

    .badge-promo::before {
        content: "";
        position: absolute;
        right: -14px;
        top: -8px;
        width: 36px;
        height: 36px;
        background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.16) 0 5px, transparent 6px),
                    radial-gradient(circle at 70% 70%, rgba(255,255,255,0.10) 0 3px, transparent 4px);
        opacity: 0.16;
        transform: rotate(10deg);
        pointer-events: none;
        filter: blur(0.5px);
    }

    /* Loading Animation */
    .loading-save {
        position: relative;
    }
    
    .loading-save::after {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255,255,255,.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
    }
    
    @keyframes spin {
        to { transform: translateY(-50%) rotate(360deg); }
    }
    
    /* Sequential Upload Styles */
    .sequential-upload-container {
        border: 2px dashed #dee2e6;
        border-radius: 12px;
        padding: 0;
        background: var(--white);
        transition: all 0.3s ease;
    }
    
    .upload-drop-zone {
        padding: 40px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        border-radius: 10px;
    }
    
    .upload-drop-zone:hover {
        border-color: var(--primary-red);
        background: rgba(255, 140, 0, 0.05);
    }
    
    .upload-drop-zone.dragover {
        border-color: var(--primary-red);
        background: rgba(255, 140, 0, 0.1);
        transform: scale(1.02);
    }
    
    .upload-icon {
        font-size: 3rem;
        color: var(--medium-gray);
        margin-bottom: 15px;
    }
    
    .upload-text {
        font-size: 1.1rem;
        color: var(--dark-gray);
        margin-bottom: 10px;
    }
    
    .upload-info {
        color: var(--medium-gray);
    }
    
    .upload-progress-container {
        background: var(--white);
        border-radius: 12px;
        padding: 20px;
        margin-top: 20px;
        border: 2px solid rgba(255, 140, 0, 0.1);
    }
    
    .upload-progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        font-weight: 600;
        color: var(--dark-gray);
    }
    
    .current-upload-status {
        background: rgba(255, 140, 0, 0.05);
        border-radius: 8px;
        padding: 15px;
        border-left: 4px solid var(--primary-red);
    }
    
    .current-file-info {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 500;
        color: var(--dark-gray);
    }
    
    .file-status {
        margin-left: auto;
        font-size: 0.9rem;
    }
    
    .file-status.processing {
        color: #ffc107;
    }
    
    .file-status.completed {
        color: #28a745;
    }
    
    .file-status.error {
        color: #dc3545;
    }
    
    .image-processing {
        border: 2px solid #ffc107;
        background: rgba(255, 193, 7, 0.1);
    }
    
    .image-completed {
        border: 2px solid #28a745;
        background: rgba(40, 167, 69, 0.1);
    }
    
    .image-error {
        border: 2px solid #dc3545;
        background: rgba(220, 53, 69, 0.1);
    }

    .processing-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.9);
        padding: 10px 15px;
        border-radius: 8px;
        box-shadow: var(--shadow);
        text-align: center;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--dark-gray);
        z-index: 3;
    }
    
    .processing-overlay i {
        display: block;
        font-size: 1.5rem;
        margin-bottom: 5px;
        color: var(--primary-red);
    }
    
    .upload-queue {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .upload-item {
        display: flex;
        align-items: center;
        padding: 10px;
        margin-bottom: 10px;
        background: var(--white);
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    
    .upload-item.processing {
        border-left: 4px solid var(--primary-red);
    }
    
    .upload-item.completed {
        border-left: 4px solid #28a745;
    }
    
    .upload-item.error {
        border-left: 4px solid #dc3545;
    }
    
    .upload-item-thumbnail {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 6px;
        margin-right: 15px;
    }
    
    .upload-item-info {
        flex: 1;
    }
    
    .upload-item-name {
        font-weight: 600;
        color: var(--dark-gray);
        margin-bottom: 5px;
    }
    
    .upload-item-status {
        font-size: 0.85rem;
        color: var(--medium-gray);
    }
    
    .upload-item-progress {
        width: 100%;
        height: 4px;
        background: #e9ecef;
        border-radius: 2px;
        margin-top: 5px;
        overflow: hidden;
    }
    
    .upload-item-progress-bar {
        height: 100%;
        background: linear-gradient(135deg, var(--primary-red), #ff6b35);
        transition: width 0.3s ease;
    }
    
    .upload-item-icon {
        margin-left: 15px;
        font-size: 1.2rem;
    }
    
    .upload-item-icon.processing {
        color: var(--primary-red);
        animation: spin 1s linear infinite;
    }
    
    .upload-item-icon.completed {
        color: #28a745;
    }
    
    .upload-item-icon.error {
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1><i class="fas fa-car me-3"></i>{% if car %}Edit Vehicle{% else %}Add New Vehicle{% endif %}</h1>
            <p>{% if car %}Update vehicle information and manage inventory{% else %}Add a new vehicle to your inventory{% endif %}</p>
        </div>
        {% if car %}
        <div>
            <a href="{% url 'admin_car_add' %}" class="btn btn-success btn-lg">
                <i class="fas fa-plus me-2"></i>Add new car
            </a>
        </div>
        {% endif %}
    </div>
</div>

<form method="post" enctype="multipart/form-data" id="vehicleForm">
    {% csrf_token %}

    <!-- Basic Information -->
    <div class="form-section">
        <h5><i class="fas fa-info-circle"></i>Basic Information</h5>
        <div class="row g-4">
            <div class="col-md-6">
                <label for="{{ form.title.id_for_label }}" class="form-label">{{ form.title.label }}</label>
                {{ form.title }}
            </div>
            <div class="col-md-6">
                <label for="{{ form.price.id_for_label }}" class="form-label">{{ form.price.label }}</label>
                <div class="input-group">
                    {{ form.price }}
                    <span class="input-group-text">€</span>
                </div>
                {% if form.price.errors %}
                    <div class="text-danger mt-1 small">
                        {% for error in form.price.errors %}
                            <div><i class="fas fa-exclamation-circle me-1"></i>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
                <div class="field-validation-error text-danger mt-1 small" id="price_error" style="display: none;">
                    <i class="fas fa-exclamation-circle me-1"></i>Invalid input
                </div>
            </div>
            <div class="col-md-6">
                <label for="{{ form.brand.id_for_label }}" class="form-label">{{ form.brand.label }}</label>
                {{ form.brand }}
            </div>
            <div class="col-md-6">
                <label for="{{ form.model_name.id_for_label }}" class="form-label">{{ form.model_name.label }}</label>
                {{ form.model_name }}
            </div>
            <div class="col-md-6">
                <label for="{{ form.year.id_for_label }}" class="form-label">{{ form.year.label }}</label>
                {{ form.year }}
                {% if form.year.errors %}
                    <div class="text-danger mt-1 small">
                        {% for error in form.year.errors %}
                            <div><i class="fas fa-exclamation-circle me-1"></i>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
                <div class="field-validation-error text-danger mt-1 small" id="year_error" style="display: none;">
                    <i class="fas fa-exclamation-circle me-1"></i>Invalid input
                </div>
            </div>
            <div class="col-md-6">
                <label for="{{ form.color.id_for_label }}" class="form-label">{{ form.color.label }}</label>
                {{ form.color }}
            </div>
            <div class="col-12">
                <label for="{{ form.description.id_for_label }}" class="form-label">{{ form.description.label }}</label>
                {{ form.description }}
            </div>
            <div class="col-12">
                <label class="form-label">Банер за возилото</label>
                <div class="banner-selection">
                    {{ form.banner_type }}
                </div>
            </div>

            <!-- Badge Selection Section -->
            <div class="col-12">
                <label class="form-label">Значки за возилото</label>
                <div class="badge-selection">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="badge-option">
                                {{ form.show_registered_badge }}
                                <label for="{{ form.show_registered_badge.id_for_label }}" class="badge-label registered">
                                    <span class="badge-preview badge-rect badge-registered">Регистрирано</span>
                                    <span class="badge-text">Регистрирано / Registered</span>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="badge-option">
                                {{ form.show_serviced_badge }}
                                <label for="{{ form.show_serviced_badge.id_for_label }}" class="badge-label serviced">
                                    <span class="badge-preview badge-rect badge-serviced">Сервисирано</span>
                                    <span class="badge-text">Сервисирано / Serviced</span>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="badge-option">
                                {{ form.show_promo_badge }}
                                <label for="{{ form.show_promo_badge.id_for_label }}" class="badge-label promo">
                                    <span class="badge-preview badge-rect badge-promo">Промо цена</span>
                                    <span class="badge-text">Промо цена / Promo Price</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6" style="display: none;">
                <div class="form-check">
                    {{ form.sold }}
                    <label for="{{ form.sold.id_for_label }}" class="form-check-label">
                        <i class="fas fa-handshake me-2"></i>{{ form.sold.label }}
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Vehicle Specifications -->
    <div class="form-section">
        <h5><i class="fas fa-cogs"></i>Vehicle Specifications</h5>
        <div class="row g-4">
            <div class="col-md-4">
                <label for="{{ form.transmission.id_for_label }}" class="form-label">{{ form.transmission.label }}</label>
                {{ form.transmission }}
            </div>
            <div class="col-md-4">
                <label for="{{ form.fuel_type.id_for_label }}" class="form-label">{{ form.fuel_type.label }}</label>
                {{ form.fuel_type }}
            </div>
            <div class="col-md-4">
                <label for="{{ form.body_type.id_for_label }}" class="form-label">{{ form.body_type.label }}</label>
                {{ form.body_type }}
            </div>
            <div class="col-md-4">
                <label for="{{ form.engine_capacity.id_for_label }}" class="form-label">{{ form.engine_capacity.label }}</label>
                <div class="input-group">
                    {{ form.engine_capacity }}
                    <span class="input-group-text">L</span>
                </div>
                {% if form.engine_capacity.errors %}
                    <div class="text-danger mt-1 small">
                        {% for error in form.engine_capacity.errors %}
                            <div><i class="fas fa-exclamation-circle me-1"></i>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
                <div class="field-validation-error text-danger mt-1 small" id="engine_capacity_error" style="display: none;">
                    <i class="fas fa-exclamation-circle me-1"></i>Invalid input
                </div>
            </div>
            <div class="col-md-4">
                <label for="{{ form.kilowatts.id_for_label }}" class="form-label">{{ form.kilowatts.label }}</label>
                <div class="input-group">
                    {{ form.kilowatts }}
                    <span class="input-group-text">kW</span>
                </div>
            </div>
            <div class="col-md-4">
                <label for="{{ form.seats.id_for_label }}" class="form-label">{{ form.seats.label }}</label>
                {{ form.seats }}
            </div>
            <div class="col-md-6">
                <label for="{{ form.registration_type.id_for_label }}" class="form-label">{{ form.registration_type.label }}</label>
                {{ form.registration_type }}
            </div>
            <div class="col-md-6">
                <label for="{{ form.mileage.id_for_label }}" class="form-label">{{ form.mileage.label }}</label>
                <div class="input-group">
                    {{ form.mileage }}
                    <span class="input-group-text">km</span>
                </div>
                {% if form.mileage.errors %}
                    <div class="text-danger mt-1 small">
                        {% for error in form.mileage.errors %}
                            <div><i class="fas fa-exclamation-circle me-1"></i>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
                <div class="field-validation-error text-danger mt-1 small" id="mileage_error" style="display: none;">
                    <i class="fas fa-exclamation-circle me-1"></i>Invalid input
                </div>
            </div>
            <div class="col-md-6">
                <label for="{{ form.consumption.id_for_label }}" class="form-label">{{ form.consumption.label }}</label>
                <div class="input-group">
                    {{ form.consumption }}
                    <span class="input-group-text">L/100км</span>
                </div>
                {% if form.consumption.errors %}
                    <div class="text-danger mt-1 small">
                        {% for error in form.consumption.errors %}
                            <div><i class="fas fa-exclamation-circle me-1"></i>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Add New Equipment -->
    <div class="form-section">
        <h5><i class="fas fa-plus-circle"></i>Add New Equipment</h5>
        <p class="text-muted mb-4">Create new equipment that will be immediately available for selection</p>
        
        <div class="add-equipment-section">
            <div class="add-equipment-form">
                <div class="equipment-input-group">
                    <label for="new-equipment-name" class="form-label">Equipment Name</label>
                    <input type="text" 
                           id="new-equipment-name" 
                           class="form-control" 
                           placeholder="Enter equipment name (max 100 characters)"
                           maxlength="100">
                    <div class="form-text">
                        <small><i class="fas fa-info-circle me-1"></i>Maximum 100 characters per name. System limit: 250 total equipment items.</small>
                    </div>
                </div>
                <button type="button" id="btn-add-equipment" class="btn-add-equipment">
                    <i class="fas fa-plus"></i>
                    <span>Add Equipment</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Equipment Selection - UPDATED WITH SEARCH - TEST 12345 -->
    <div class="form-section">
        <h5><i class="fas fa-tools"></i>Vehicle Equipment</h5>
        <p class="text-muted mb-4">Select the equipment and features included with this vehicle</p>
        <div class="dual-list">
            <div class="dual-list-column">
                <div class="dual-list-header">Available Equipment</div>
                <div class="mb-3">
                    <input type="text" 
                           id="equipment-search" 
                           class="form-control mb-2" 
                           placeholder="🔍 Search available equipment..."
                           style="border-radius: 8px; padding: 10px 15px; font-size: 0.9rem;">
                </div>
                <div class="mb-3">
                    <button type="button" class="btn btn-sm btn-outline-primary me-2" id="select-all-left">
                        <i class="fas fa-check-double"></i> Select All
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="unselect-all-left">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
                <select id="available-equipment" multiple class="form-select">
                    {% for eq in all_equipment %}
                        {% if eq not in selected_equipment %}
                            <option value="{{ eq.id }}">{{ eq.name }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            
            <div class="dual-list-buttons">
                <button type="button" class="btn btn-primary" id="add-equipment" title="Add selected equipment">
                    <i class="fas fa-arrow-right"></i>
                </button>
                <button type="button" class="btn btn-secondary" id="remove-equipment" title="Remove selected equipment">
                    <i class="fas fa-arrow-left"></i>
                </button>
            </div>
            
            <div class="dual-list-column">
                <div class="dual-list-header">Selected Equipment</div>
                <div class="mb-3">
                    <button type="button" class="btn btn-sm btn-outline-primary me-2" id="select-all-right">
                        <i class="fas fa-check-double"></i> Select All
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="unselect-all-right">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
                <select id="selected-equipment" name="equipment" multiple class="form-select">
                    {% for eq in selected_equipment %}
                        <option value="{{ eq.id }}">{{ eq.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <!-- Main Image -->
    <div class="form-section">
        <h5><i class="fas fa-camera"></i>Main Vehicle Image</h5>
        <div class="row">
            <div class="col-md-6">
                <label for="{{ form.main_image.id_for_label }}" class="form-label">{{ form.main_image.label }}</label>
                <input type="file" name="{{ form.main_image.name }}" id="{{ form.main_image.id_for_label }}" 
                       class="form-control" accept="image/*">
                <div class="form-text">Recommended size: 800x600px. Max file size: 5MB</div>
                {% if form.main_image.errors %}
                    <div class="text-danger mt-2">{{ form.main_image.errors }}</div>
                {% endif %}
            </div>
            <div class="col-md-6">
                {% if car and car.main_image %}
                    <div class="text-center">
                        <label class="form-label">Current Main Image</label><br>
                        <img src="{{ car.main_image.url }}" class="img-preview" alt="Current main image">
                    </div>
                {% else %}
                    <div class="text-center text-muted">
                        <i class="fas fa-image" style="font-size: 4rem; opacity: 0.3;"></i>
                        <div class="mt-2">No main image uploaded</div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Additional Images -->
    <div class="form-section">
        <h5><i class="fas fa-images"></i>Additional Images</h5>
        <div class="mb-3" id="drag-drop-info"{% if not images %} style="display: none;"{% endif %}>
            <div class="alert alert-info d-flex align-items-center">
                <i class="fas fa-info-circle me-2"></i>
                <small>Drag and drop images to reorder them. The first image will be shown first in the gallery.</small>
            </div>
        </div>
        <div class="image-gallery" id="sortable-images">
            {% for img in images %}
            <div class="image-item" data-id="{{ img.id }}">
                <div class="image-position-badge">{{ forloop.counter }}</div>
                <div class="drag-handle">
                    <i class="fas fa-grip-vertical"></i>
                </div>
                <img src="{{ img.image.url }}" alt="Vehicle image">
                <button type="button" data-id="{{ img.id }}" class="btn btn-danger btn-sm delete-image-btn">
                    <i class="fas fa-trash me-1"></i>Delete
                </button>
            </div>
            {% empty %}
            <div class="col-12 text-center text-muted py-4" id="no-images-message">
                <i class="fas fa-images" style="font-size: 3rem; opacity: 0.3;"></i>
                <div class="mt-2">No additional images uploaded</div>
            </div>
            {% endfor %}
        </div>

        <div class="mt-4">
            <label class="form-label">Add New Images</label>
            <div class="sequential-upload-container">
                <div class="upload-drop-zone" id="upload-drop-zone">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div class="upload-text">
                        <strong>Drag & drop images here</strong> or <span class="text-primary">click to browse</span>
                    </div>
                    <div class="upload-info">
                        <small>Images will be processed one by one with compression and thumbnail generation</small>
                    </div>
                    <input type="file" id="image-upload-input" class="d-none" accept="image/*" multiple>
                </div>
                <div class="upload-progress-container" id="upload-progress-container" style="display: none;">
                    <div class="upload-progress-header">
                        <span id="upload-current-file">Processing image 1 of 3...</span>
                        <span id="upload-overall-progress">33%</span>
                    </div>
                    <div class="progress mb-2">
                        <div class="progress-bar" id="overall-progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="current-upload-status" id="current-upload-status">
                        <div class="current-file-info">
                            <i class="fas fa-image me-2"></i>
                            <span id="current-file-name">image.jpg</span>
                            <span class="file-status" id="current-file-status">
                                <i class="fas fa-spinner fa-spin"></i> Processing...
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-text" id="image-limit-text">Images are processed individually with automatic compression and thumbnail generation. Max 12 images total.</div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
        <a href="{% url 'admin_car_list' %}" class="btn-back">
            <i class="fas fa-arrow-left"></i> Back to List
        </a>
        <button type="submit" class="btn-save" id="saveButton">
            <i class="fas fa-save"></i>
            <span id="saveText">{% if car %}Update Vehicle{% else %}Save Vehicle{% endif %}</span>
        </button>
    </div>
</form>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
// ✅ NUMERIC FIELD VALIDATION FUNCTION
function validateNumericField(field) {
    const fieldName = field.name;
    const value = field.value;
    const errorDiv = document.getElementById(fieldName + '_error');
    
    // Hide error message first
    if (errorDiv) {
        errorDiv.style.display = 'none';
    }
    
    // Check for invalid input (negative numbers, 'e', '+', '-')
    if (value !== '' && (value < 0 || value.includes('-') || value.includes('e') || value.includes('+'))) {
        // Prevent the invalid character/value
        field.value = field.value.replace(/[-+e]/g, '');
        
        // Show error message only (no red border)
        if (errorDiv) {
            errorDiv.style.display = 'block';
        }
        return false;
    }
    
    return true;
}

document.addEventListener("DOMContentLoaded", () => {
    // DEBUG: Check if equipment search exists
    console.log('DOM LOADED - SEARCH DEBUG TEST 12345');
    const searchElement = document.getElementById('equipment-search');
    console.log('Search element found:', searchElement);
    if (searchElement) {
        console.log('Search element placeholder:', searchElement.placeholder);
    } else {
        console.log('ERROR: Search element not found!');
    }
    // Enhanced Brand/Model Loading
    const brandField = document.getElementById("id_brand");
    const modelField = document.getElementById("id_model_name");
    const preselect = modelField.value;

    function loadModels(brandId, selected = null) {
        if (!brandId) {
            modelField.disabled = true;
            modelField.innerHTML = '<option value="">Select brand first</option>';
            return;
        }
        
        modelField.disabled = true;
        modelField.innerHTML = '<option>Loading models...</option>';

        fetch(`/ajax/load-models/?brand=${brandId}`)
            .then(r => r.json())
            .then(data => {
                modelField.disabled = false;
                modelField.innerHTML = '<option value="">Choose a model</option>';
                data.forEach(m => {
                    const o = document.createElement("option");
                    o.value = m.id;
                    o.textContent = m.name;
                    if (selected && String(m.id) === String(selected)) {
                        o.selected = true;
                    }
                    modelField.append(o);
                });
            })
            .catch(() => {
                modelField.disabled = true;
                modelField.innerHTML = '<option>Error loading models</option>';
            });
    }

    // Initialize model field
    if (brandField.value) {
        loadModels(brandField.value, preselect);
    } else {
        modelField.disabled = true;
        modelField.innerHTML = '<option value="">Select brand first</option>';
    }

    brandField.addEventListener("change", e => {
        loadModels(e.target.value);
    });

    // ✅ DRAG & DROP IMAGE REORDERING
    const sortableContainer = document.getElementById('sortable-images');
    if (sortableContainer && sortableContainer.children.length > 0) {
        const sortable = Sortable.create(sortableContainer, {
            animation: 200,
            delay: 50,
            touchStartThreshold: 5,
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-drag',
            dragClass: 'sortable-drag',
            onEnd: function(evt) {
                if (evt.oldIndex !== evt.newIndex) {
                    updateImageOrder();
                }
            }
        });
    }

    // Function to update image order via AJAX
    function updateImageOrder() {
        const imageItems = document.querySelectorAll('#sortable-images .image-item');
        const imageIds = Array.from(imageItems).map(item => item.getAttribute('data-id'));
        
        if (imageIds.length === 0) return;
        
        fetch('/ajax/reorder-car-images/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: JSON.stringify({
                'image_ids': imageIds
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update position badges
                updatePositionBadges();
                showToast('Images reordered successfully!');
            } else {
                showToast('Failed to reorder images: ' + (data.error || 'Unknown error'), 'error');
            }
        })
        .catch(error => {
            console.error('Error reordering images:', error);
            showToast('Error reordering images', 'error');
        });
    }

    // Function to update position badges
    function updatePositionBadges() {
        const positionBadges = document.querySelectorAll('#sortable-images .image-position-badge');
        positionBadges.forEach((badge, index) => {
            badge.textContent = index + 1;
        });
    }

    // SIMPLE WORKING SEARCH FUNCTIONALITY
    const searchInput = document.getElementById('equipment-search');
    const availableSelect = document.getElementById('available-equipment');
    
    if (searchInput && availableSelect) {
        // Store original options
        const allOptions = Array.from(availableSelect.options).map(opt => ({
            value: opt.value,
            text: opt.textContent,
            html: opt.outerHTML
        }));
        
        console.log('✅ Search setup complete with', allOptions.length, 'options');
        
        // Search on every keystroke
        searchInput.addEventListener('input', function() {
            const search = this.value.toLowerCase();
            console.log('🔍 Searching:', search);
            
            availableSelect.innerHTML = '';
            
            if (search === '') {
                // Show all
                allOptions.forEach(opt => {
                    availableSelect.innerHTML += opt.html;
                });
            } else {
                // Show matches
                let matches = 0;
                allOptions.forEach(opt => {
                    if (opt.text.toLowerCase().includes(search)) {
                        availableSelect.innerHTML += opt.html;
                        matches++;
                    }
                });
                
                if (matches === 0) {
                    availableSelect.innerHTML = '<option disabled>No matches found</option>';
                }
            }
        });
    } else {
        console.log('❌ Search elements not found');
    }

    // Simple double-click functionality
    availableSelect.addEventListener("dblclick", function(e) {
        if (e.target.tagName === "OPTION" && !e.target.disabled) {
            const selectedSelect = document.getElementById("selected-equipment");
            
            // Check if already selected
            const exists = Array.from(selectedSelect.options).find(opt => opt.value === e.target.value);
            if (!exists) {
                // Add to selected
                const newOption = e.target.cloneNode(true);
                newOption.selected = false;
                selectedSelect.appendChild(newOption);
                
                // Remove from current available list
                e.target.remove();
                
                console.log(`✅ Added "${newOption.textContent}"`);
            } else {
                console.log(`⚠️ Already selected`);
            }
        }
    });
    
    // Enhanced Equipment Dual List with Better UX and Duplicate Prevention
    function enableToggle(selectId) {
        const selectEl = document.getElementById(selectId);
        selectEl.addEventListener("mousedown", function(e) {
            if (e.target.tagName === "OPTION") {
                e.preventDefault();
                const scrollPos = selectEl.scrollTop;
                e.target.selected = !e.target.selected;
                setTimeout(() => selectEl.scrollTop = scrollPos, 0);
                
                // Visual feedback
                e.target.style.backgroundColor = e.target.selected ? 'rgba(255, 140, 0, 0.2)' : '';
            }
        });
    }
    
    enableToggle("selected-equipment");

    // Simplified move options function
    function moveOptions(fromId, toId) {
        const from = document.getElementById(fromId);
        const to = document.getElementById(toId);
        let moved = 0;
        let duplicates = 0;
        
        // Get selected options
        const selectedOptions = Array.from(from.options).filter(option => 
            option.selected && !option.disabled
        );
        
        selectedOptions.forEach(option => {
            // Check if already exists in target
            const exists = Array.from(to.options).find(existing => existing.value === option.value);
            
            if (!exists) {
                // Add to target
                const newOption = option.cloneNode(true);
                newOption.selected = false;
                to.appendChild(newOption);
                moved++;
                
                // Remove from source
                option.remove();
            } else {
                duplicates++;
                option.selected = false;
            }
        });
        
        // Show results
        if (moved > 0) showToast(`Moved ${moved} equipment item(s)`);
        if (duplicates > 0) showToast(`Skipped ${duplicates} duplicate(s)`, 'warning');
    }

    document.getElementById("add-equipment").onclick = () => moveOptions("available-equipment", "selected-equipment");
    document.getElementById("remove-equipment").onclick = () => moveOptions("selected-equipment", "available-equipment");

    // Enhanced Select All/Clear functionality
    document.getElementById("select-all-left").onclick = () => {
        const options = document.getElementById("available-equipment").options;
        let selectedCount = 0;
        for (let opt of options) {
            if (!opt.disabled) {
                opt.selected = true;
                opt.style.backgroundColor = 'rgba(255, 140, 0, 0.2)';
                selectedCount++;
            }
        }
        showToast(`Selected ${selectedCount} available items`);
    };
    
    document.getElementById("unselect-all-left").onclick = () => {
        const options = document.getElementById("available-equipment").options;
        for (let opt of options) {
            opt.selected = false;
            opt.style.backgroundColor = '';
        }
        showToast('Cleared available selection');
    };
    
    document.getElementById("select-all-right").onclick = () => {
        const options = document.getElementById("selected-equipment").options;
        for (let opt of options) {
            opt.selected = true;
            opt.style.backgroundColor = 'rgba(255, 140, 0, 0.2)';
        }
        showToast(`Selected ${options.length} included items`);
    };
    
    document.getElementById("unselect-all-right").onclick = () => {
        const options = document.getElementById("selected-equipment").options;
        for (let opt of options) {
            opt.selected = false;
            opt.style.backgroundColor = '';
        }
        showToast('Cleared selected equipment');
    };

    // Double-click functionality for selected equipment to move back to available
    document.getElementById("selected-equipment").addEventListener("dblclick", function(e) {
        if (e.target.tagName === "OPTION") {
            const availableSelect = document.getElementById("available-equipment");
            
            // Clone the option
            const newOption = e.target.cloneNode(true);
            newOption.selected = false;
            
            // Add to available
            availableSelect.appendChild(newOption);
            
            // Remove from selected
            e.target.remove();
            
            showToast(`Moved "${newOption.textContent}" back to available`);
        }
    });

    // ✅ ADD NEW EQUIPMENT FUNCTIONALITY
    const newEquipmentInput = document.getElementById('new-equipment-name');
    const addEquipmentBtn = document.getElementById('btn-add-equipment');
    const availableEquipmentSelect = document.getElementById('available-equipment');
    const equipmentSearch = document.getElementById('equipment-search'); // Define search element

    // Add equipment on button click
    addEquipmentBtn.addEventListener('click', function() {
        addNewEquipment();
    });

    // Add equipment on Enter key press
    newEquipmentInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            addNewEquipment();
        }
    });

    function addNewEquipment() {
        const equipmentName = newEquipmentInput.value.trim();
        
        if (!equipmentName) {
            showToast('Please enter equipment name', 'error');
            newEquipmentInput.focus();
            return;
        }

        if (equipmentName.length < 2) {
            showToast('Equipment name must be at least 2 characters long', 'error');
            newEquipmentInput.focus();
            return;
        }

        if (equipmentName.length > 100) {
            showToast('Equipment name must be 100 characters or less', 'error');
            newEquipmentInput.focus();
            return;
        }

        // Add loading state
        addEquipmentBtn.disabled = true;
        addEquipmentBtn.classList.add('loading');
        const originalText = addEquipmentBtn.querySelector('span').textContent;
        addEquipmentBtn.querySelector('span').textContent = 'Adding...';

        fetch('/ajax/add-equipment/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: JSON.stringify({
                'name': equipmentName
            })
        })
        .then(response => {
            console.log('Equipment AJAX Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Equipment AJAX Response data:', data);
            if (data.success) {
                console.log('Equipment added successfully:', data.equipment);
                
                // Create new option element
                const newOption = document.createElement('option');
                newOption.value = data.equipment.id;
                newOption.textContent = data.equipment.name;
                
                // Simple approach: just add to the end and then sort all options
                availableEquipmentSelect.appendChild(newOption);
                
                // Get all options and sort them alphabetically
                const allOptions = Array.from(availableEquipmentSelect.options);
                allOptions.sort((a, b) => a.textContent.localeCompare(b.textContent));
                
                // Clear select and add sorted options back
                availableEquipmentSelect.innerHTML = '';
                allOptions.forEach(option => {
                    availableEquipmentSelect.appendChild(option);
                });

                // Clear input
                newEquipmentInput.value = '';
                
                // Show success message
                showToast(data.message || 'Equipment added successfully!', 'success');

                // Focus back to input for quick adding
                newEquipmentInput.focus();
            } else {
                console.error('Equipment addition failed:', data.error);
                showToast(data.error || 'Failed to add equipment', 'error');
                newEquipmentInput.focus();
            }
        })
        .catch(error => {
            console.error('Error adding equipment:', error);
            showToast(`Error adding equipment: ${error.message}`, 'error');
        })
        .finally(() => {
            // Remove loading state
            addEquipmentBtn.disabled = false;
            addEquipmentBtn.classList.remove('loading');
            addEquipmentBtn.querySelector('span').textContent = originalText;
        });
    }

    // Enhanced form submission with validation and loading state
    const form = document.getElementById("vehicleForm");
    const saveButton = document.getElementById("saveButton");
    const saveText = document.getElementById("saveText");
    
    form.onsubmit = (e) => {
        // Mark all selected equipment
        const selected = document.getElementById("selected-equipment");
        for (let option of selected.options) option.selected = true;
        
        // Add loading state
        saveButton.classList.add('loading-save');
        saveButton.disabled = true;
        saveText.textContent = 'Saving...';
        
        // Basic validation
        const title = document.getElementById("id_title").value.trim();
        const price = document.getElementById("id_price").value.trim();
        const brand = document.getElementById("id_brand").value;
        
        if (!title || !price || !brand) {
            e.preventDefault();
            saveButton.classList.remove('loading-save');
            saveButton.disabled = false;
            saveText.textContent = '{% if car %}Update Vehicle{% else %}Save Vehicle{% endif %}';
            showToast('Please fill in all required fields', 'error');
            return false;
        }
        
        showToast('Saving vehicle information...');
    };

    // Enhanced AJAX Image Deletion with better UX (no confirmation)
    document.querySelectorAll(".delete-image-btn").forEach(btn => {
        btn.addEventListener("click", function() {
            handleImageDelete(this);
        });
    });

    // Form sections animation on page load
    const formSections = document.querySelectorAll('.form-section');
    formSections.forEach((section, index) => {
        section.style.opacity = '0';
        section.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            section.style.transition = 'all 0.6s ease';
            section.style.opacity = '1';
            section.style.transform = 'translateY(0)';
        }, index * 100);
    });

    // Image limit validation
    function updateImageLimitText() {
        const existingImages = document.querySelectorAll('.image-item').length;
        const remaining = 12 - existingImages;
        const limitText = document.getElementById('image-limit-text');
        
        if (remaining <= 0) {
            limitText.textContent = 'Maximum of 12 images reached. Please delete some images to add new ones.';
            limitText.className = 'form-text text-danger';
        } else {
            limitText.textContent = `You can add ${remaining} more image${remaining !== 1 ? 's' : ''}. Max 12 images total.`;
            limitText.className = 'form-text';
        }
    }
    
    // Validate image selection
    function validateImageLimit(fileInput) {
        const existingImages = document.querySelectorAll('.image-item').length;
        const selectedFiles = fileInput.files.length;
        const remaining = 12 - existingImages;
        
        if (selectedFiles > remaining) {
            showToast(`You can only add ${remaining} more image${remaining !== 1 ? 's' : ''}. You selected ${selectedFiles} files.`, 'error');
            fileInput.value = ''; // Clear the selection
            return false;
        }
        return true;
    }

    // Toast notification system
    function showToast(message, type = 'success') {
        // Remove existing toasts
        const existingToasts = document.querySelectorAll('.toast-notification');
        existingToasts.forEach(toast => toast.remove());
        
        const toast = document.createElement('div');
        toast.className = `toast-notification toast-${type}`;
        
        // Choose appropriate icon and color based on type
        let icon, backgroundColor;
        switch(type) {
            case 'success':
                icon = 'check-circle';
                backgroundColor = 'var(--success-green)';
                break;
            case 'warning':
                icon = 'exclamation-triangle';
                backgroundColor = '#ffc107';
                break;
            case 'error':
                icon = 'exclamation-circle';
                backgroundColor = '#ff8c00';
                break;
            default:
                icon = 'info-circle';
                backgroundColor = '#17a2b8';
        }
        
        toast.innerHTML = `
            <i class="fas fa-${icon} me-2"></i>
            ${message}
        `;
        
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${backgroundColor};
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            z-index: 9999;
            font-weight: 500;
            transform: translateX(100%);
            transition: all 0.3s ease;
            max-width: 400px;
            word-wrap: break-word;
        `;
        
        document.body.appendChild(toast);
        
        // Animate in
        setTimeout(() => {
            toast.style.transform = 'translateX(0)';
        }, 100);
        
        // Animate out and remove (longer delay for warnings/errors)
        const delay = type === 'warning' || type === 'error' ? 4000 : 3000;
        setTimeout(() => {
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => toast.remove(), 300);
        }, delay);
    }

    // Enhanced file input preview
    const mainImageInput = document.getElementById('id_main_image');
    if (mainImageInput) {
        mainImageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Create or update preview
                    let preview = document.querySelector('.main-image-preview');
                    if (!preview) {
                        preview = document.createElement('img');
                        preview.className = 'img-preview main-image-preview mt-3';
                        mainImageInput.parentNode.appendChild(preview);
                    }
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });
    }
    
    // Add image limit validation to file input
    const imageInput = document.querySelector('input[type="file"][multiple]');
    if (imageInput) {
        imageInput.addEventListener('change', function(e) {
            validateImageLimit(this);
        });
    }
    
    // Initialize image limit text on page load
    updateImageLimitText();

    // Note: Field error highlighting removed as per user request - only text errors should show
    
    // Note: Real-time validation simplified - removed red borders, keeping only oninput validation

    // Banner functionality is now handled by standard radio buttons - no custom JS needed

    // ✅ SEQUENTIAL IMAGE UPLOAD FUNCTIONALITY
    const uploadDropZone = document.getElementById('upload-drop-zone');
    const imageUploadInput = document.getElementById('image-upload-input');
    const uploadProgressContainer = document.getElementById('upload-progress-container');
    const overallProgressBar = document.getElementById('overall-progress-bar');
    const uploadCurrentFile = document.getElementById('upload-current-file');
    const uploadOverallProgress = document.getElementById('upload-overall-progress');
    const currentFileName = document.getElementById('current-file-name');
    const currentFileStatus = document.getElementById('current-file-status');
    const sortableImagesContainer = document.getElementById('sortable-images');
    
    let uploadQueue = [];
    let currentUploadIndex = 0;
    let totalUploads = 0;

    // Drag and drop functionality
    if (uploadDropZone) {
        uploadDropZone.addEventListener('click', () => {
            imageUploadInput.click();
        });
        
        uploadDropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadDropZone.classList.add('dragover');
        });
        
        uploadDropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadDropZone.classList.remove('dragover');
        });
        
        uploadDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadDropZone.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            handleFileSelection(files);
        });
        
        imageUploadInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handleFileSelection(files);
        });
    }

    function handleFileSelection(files) {
        if (!files || files.length === 0) return;
        
        // First check if we're on add page and validate required fields
        const carIdElement = document.querySelector('input[name="car_id"]');
        const carId = carIdElement ? carIdElement.value : {% if car %}{{ car.id }}{% else %}null{% endif %};
        
        if (!carId) {
            // Validate required fields before allowing any upload
            const emptyFields = validateRequiredFields();
            if (emptyFields.length > 0) {
                // Show error message in Macedonian
                const fieldNames = emptyFields.map(f => f.label).join(', ');
                const errorMessage = `Некои полиња не се пополнети: ${fieldNames}. Ве молиме пополнете ги потребните полиња пред да додавате слики.`;
                
                showToast(errorMessage, 'error');
                
                // Focus on first empty field
                const firstEmptyField = document.getElementById(emptyFields[0].id);
                if (firstEmptyField) {
                    firstEmptyField.focus();
                    firstEmptyField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Add red border to highlight the field
                    firstEmptyField.style.borderColor = '#dc3545';
                    firstEmptyField.style.borderWidth = '2px';
                    
                    // Remove red border after 5 seconds
                    setTimeout(() => {
                        firstEmptyField.style.borderColor = '';
                        firstEmptyField.style.borderWidth = '';
                    }, 5000);
                }
                
                return; // Stop the upload process completely
            }
        }
        
        // Filter only image files
        const imageFiles = files.filter(file => file.type.startsWith('image/'));
        
        if (imageFiles.length === 0) {
            showToast('Please select valid image files', 'error');
            return;
        }
        
        // Check image limit
        const existingImages = document.querySelectorAll('.image-item').length;
        const totalAfterUpload = existingImages + imageFiles.length;
        
        if (totalAfterUpload > 12) {
            const canUpload = 12 - existingImages;
            if (canUpload <= 0) {
                showToast('Maximum of 12 images reached. Please delete some images first.', 'error');
                return;
            }
            showToast(`You can only upload ${canUpload} more image${canUpload !== 1 ? 's' : ''}. ${imageFiles.length - canUpload} files will be skipped.`, 'warning');
            imageFiles.splice(canUpload);
        }
        
        // Validate file sizes
        const validFiles = imageFiles.filter(file => {
            if (file.size > 5 * 1024 * 1024) {
                showToast(`File "${file.name}" is too large (max 5MB)`, 'warning');
                return false;
            }
            return true;
        });
        
        if (validFiles.length === 0) {
            showToast('No valid files to upload', 'error');
            return;
        }
        
        // Start sequential upload
        startSequentialUpload(validFiles);
    }

    function startSequentialUpload(files) {
        uploadQueue = files;
        currentUploadIndex = 0;
        totalUploads = files.length;
        
        // Show progress container
        uploadProgressContainer.style.display = 'block';
        
        // Remove "no images" message if it exists
        const noImagesMsg = document.getElementById('no-images-message');
        if (noImagesMsg) {
            noImagesMsg.remove();
        }
        
        // Reset input
        imageUploadInput.value = '';
        
        // Start first upload
        uploadNextImage();
    }

    function createUploadItem(file, index) {
        const item = document.createElement('div');
        item.className = 'upload-item';
        item.id = `upload-item-${index}`;

        // Create thumbnail preview
        const thumbnail = document.createElement('img');
        thumbnail.className = 'upload-item-thumbnail';
        thumbnail.alt = file.name;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            thumbnail.src = e.target.result;
        };
        reader.readAsDataURL(file);

        item.innerHTML = `
            <div class="upload-item-info">
                <div class="upload-item-name">${file.name}</div>
                <div class="upload-item-status">Waiting...</div>
                <div class="upload-item-progress">
                    <div class="upload-item-progress-bar" style="width: 0%"></div>
                </div>
            </div>
            <div class="upload-item-icon">
                <i class="fas fa-clock"></i>
            </div>
        `;

        // Insert thumbnail as first child
        item.insertBefore(thumbnail, item.firstChild);

        return item;
    }
    
    function validateRequiredFields() {
        const requiredFields = [
            { id: 'id_brand', label: 'Марка' },
            { id: 'id_model_name', label: 'Модел' },
            { id: 'id_title', label: 'Наслов' },
            { id: 'id_year', label: 'Година на производство' },
            { id: 'id_price', label: 'Цена' },
            { id: 'id_fuel_type', label: 'Тип на гориво' },
            { id: 'id_transmission', label: 'Менувач' },
            { id: 'id_body_type', label: 'Тип на каросерија' },
            { id: 'id_registration_type', label: 'Регистрација' },
            { id: 'id_kilowatts', label: 'Киловати' },
            { id: 'id_mileage', label: 'Километража' },
            { id: 'id_color', label: 'Боја' },
            { id: 'id_seats', label: 'Број на седишта' }
        ];
        
        const emptyFields = [];
        
        for (const field of requiredFields) {
            const element = document.getElementById(field.id);
            if (element && (!element.value || element.value.trim() === '' || element.value === '')) {
                emptyFields.push(field);
            }
        }
        
        return emptyFields;
    }

    function autoSaveCarAndUpload(file) {
        console.log('🚗 AUTO-SAVE: Starting auto-save for', file.name);
        currentFileStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving car first...';
        currentFileStatus.className = 'file-status processing';
        
        // Gather form data
        const form = document.querySelector('form');
        const formData = new FormData(form);
        
        // Ensure selected equipment is included
        const selectedEquipment = document.getElementById('selected-equipment');
        if (selectedEquipment) {
            // Clear any existing equipment values to avoid duplicates
            formData.delete('equipment');
            Array.from(selectedEquipment.options).forEach(option => {
                formData.append('equipment', option.value);
            });
        }
        
        // Send AJAX request to save the car
        fetch(window.location.pathname, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('✅ AUTO-SAVE: Car saved with ID:', data.car_id);
                // Car saved successfully, now upload the image
                currentFileStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Car saved, uploading image...';
                
                showToast('Car saved successfully!', 'success');
                
                // Create a hidden input to store the car ID for future uploads
                let carIdInput = document.querySelector('input[name="car_id"]');
                if (!carIdInput) {
                    carIdInput = document.createElement('input');
                    carIdInput.type = 'hidden';
                    carIdInput.name = 'car_id';
                    document.querySelector('form').appendChild(carIdInput);
                }
                carIdInput.value = data.car_id;
                
                // Update the form action to edit mode
                const form = document.querySelector('form');
                form.action = `/dashboard/cars/${data.car_id}/edit/`;
                
                // Update the page title and button text to reflect we're now editing
                const saveButton = document.getElementById('saveText');
                if (saveButton) {
                    saveButton.textContent = 'Update Vehicle';
                }
                
                // Make sure the no-images message is removed if it exists
                const noImagesMsg = document.getElementById('no-images-message');
                if (noImagesMsg) {
                    noImagesMsg.remove();
                }
                
                // Show drag-drop info for future uploads
                const dragDropInfo = document.getElementById('drag-drop-info');
                if (dragDropInfo) {
                    if (dragDropInfo.style.display === 'none' || window.getComputedStyle(dragDropInfo).display === 'none') {
                        dragDropInfo.style.display = 'block';
                    }
                }
                
                // Now upload the image
                uploadSingleFile(file, data.car_id);
            } else {
                console.error('AUTO-SAVE: Save failed:', data);
                throw new Error(data.message || 'Failed to save car');
            }
        })
        .catch(error => {
            console.error('Auto-save error:', error);
            currentFileStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i> Auto-save failed';
            currentFileStatus.className = 'file-status error';
            showToast(error.message || 'Failed to save car before uploading image', 'error');
            finishUpload();
        });
    }
    
    function uploadSingleFile(file, carId) {
        console.log('📁 UPLOAD: Starting upload for', file.name, 'to car', carId);
        currentFileStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
        currentFileStatus.className = 'file-status processing';
        
        const formData = new FormData();
        formData.append('image', file);
        formData.append('car_id', carId);
        
        fetch('/ajax/upload-single-image/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('✅ UPLOAD: Success! Image ID:', data.image_id);
                currentFileStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                
                // Add temporary image item to UI
                addTemporaryImageItem(data, file.name);
                
                // Start checking processing status
                checkImageProcessingStatus(data.image_id, () => {
                    // On completion, move to next image
                    currentUploadIndex++;
                    uploadNextImage();
                });
                
            } else {
                console.error('❌ UPLOAD: Failed:', data.error);
                throw new Error(data.error || 'Upload failed');
            }
        })
        .catch(error => {
            console.error('Upload error:', error);
            currentFileStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i> Failed';
            currentFileStatus.className = 'file-status error';
            
            showToast(`Failed to upload ${file.name}: ${error.message}`, 'error');
            
            // Continue to next image
            currentUploadIndex++;
            uploadNextImage();
        });
    }

    function uploadFilesSequentially(files, currentIndex) {
        if (currentIndex >= files.length) {
            // All files processed
            completeUpload(files.length);
            return;
        }

        const file = files[currentIndex];
        const uploadItem = document.getElementById(`upload-item-${currentIndex}`);
        
        // Update UI
        uploadItem.classList.add('processing');
        uploadItem.querySelector('.upload-item-status').textContent = 'Uploading...';
        uploadItem.querySelector('.upload-item-icon').innerHTML = '<i class="fas fa-spinner processing"></i>';
        uploadItem.querySelector('.upload-item-progress-bar').style.width = '30%';

        uploadStatus.textContent = `Processing ${currentIndex + 1} of ${files.length} images...`;

        // Create form data
        const formData = new FormData();
        formData.append('car_id', currentCarId);
        formData.append('image', file);

        // Upload via AJAX
        fetch('/ajax/upload-single-image/', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                uploadItem.classList.remove('processing');
                uploadItem.classList.add('completed');
                uploadItem.querySelector('.upload-item-status').textContent = 'Completed';
                uploadItem.querySelector('.upload-item-icon').innerHTML = '<i class="fas fa-check-circle completed"></i>';
                uploadItem.querySelector('.upload-item-progress-bar').style.width = '100%';
                
                uploadedFiles.push(data.image);
                
                // Add to image gallery
                addImageToGallery(data.image);
                
                // Update progress
                updateProgressBar(currentIndex + 1, files.length);
                
                // Continue with next file after a small delay
                setTimeout(() => {
                    uploadFilesSequentially(files, currentIndex + 1);
                }, 500);
            } else {
                handleUploadError(uploadItem, data.error || 'Upload failed');
                // Continue with next file even if this one failed
                setTimeout(() => {
                    uploadFilesSequentially(files, currentIndex + 1);
                }, 1000);
            }
        })
        .catch(error => {
            handleUploadError(uploadItem, 'Network error');
            // Continue with next file
            setTimeout(() => {
                uploadFilesSequentially(files, currentIndex + 1);
            }, 1000);
        });
    }

    function handleUploadError(uploadItem, error) {
        uploadItem.classList.remove('processing');
        uploadItem.classList.add('error');
        uploadItem.querySelector('.upload-item-status').textContent = `Error: ${error}`;
        uploadItem.querySelector('.upload-item-icon').innerHTML = '<i class="fas fa-exclamation-circle error"></i>';
        uploadItem.querySelector('.upload-item-progress-bar').style.width = '100%';
        uploadItem.querySelector('.upload-item-progress-bar').style.background = '#dc3545';
    }

    function addImageToGallery(imageData) {
        const sortableImages = document.getElementById('sortable-images');
        const noImagesMessage = document.getElementById('no-images-message');
        
        // Remove "no images" message if it exists
        if (noImagesMessage) {
            noImagesMessage.remove();
        }

        // Create new image item
        const imageItem = document.createElement('div');
        imageItem.className = 'image-item';
        imageItem.setAttribute('data-id', imageData.id);
        
        const currentImageCount = sortableImages.children.length + 1;
        
        imageItem.innerHTML = `
            <div class="image-position-badge">${currentImageCount}</div>
            <div class="drag-handle">
                <i class="fas fa-grip-vertical"></i>
            </div>
            <img src="${imageData.thumbnail_url || imageData.url}" alt="Vehicle image">
            <button type="button" data-id="${imageData.id}" class="btn btn-danger btn-sm delete-image-btn">
                <i class="fas fa-trash me-1"></i>Delete
            </button>
        `;

        // Add delete functionality
        const deleteBtn = imageItem.querySelector('.delete-image-btn');
        deleteBtn.addEventListener('click', function() {
            deleteImage(this.dataset.id, imageItem);
        });

        sortableImages.appendChild(imageItem);
        updateImageLimitText();
    }

    function completeUpload(totalFiles) {
        uploadInProgress = false;
        const successCount = uploadedFiles.length;
        const errorCount = totalFiles - successCount;
        
        if (successCount > 0) {
            showToast(`Successfully uploaded ${successCount} image(s)`, 'success');
        }
        
        if (errorCount > 0) {
            showToast(`${errorCount} image(s) failed to upload`, 'error');
        }

        uploadStatus.textContent = `Completed: ${successCount} successful, ${errorCount} failed`;
        
        // Hide progress container after delay
        setTimeout(() => {
            progressContainer.style.display = 'none';
        }, 3000);
    }

    function updateProgressBar(current, total) {
        const percentage = (current / total) * 100;
        progressBar.style.width = percentage + '%';
    }

    function uploadNextImage() {
        if (currentUploadIndex >= totalUploads) {
            // All uploads completed
            finishUpload();
            return;
        }
        
        const file = uploadQueue[currentUploadIndex];
        const progressPercent = Math.round(((currentUploadIndex) / totalUploads) * 100);
        
        // Update UI
        uploadCurrentFile.textContent = `Processing image ${currentUploadIndex + 1} of ${totalUploads}...`;
        uploadOverallProgress.textContent = `${progressPercent}%`;
        overallProgressBar.style.width = `${progressPercent}%`;
        currentFileName.textContent = file.name;
        currentFileStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
        currentFileStatus.className = 'file-status processing';
        
        // Get car ID (if editing existing car)
        const carIdElement = document.querySelector('input[name="car_id"]');
        const carId = carIdElement ? carIdElement.value : {% if car %}{{ car.id }}{% else %}null{% endif %};
        
        if (!carId) {
            // Auto-save the car first, then upload image
            autoSaveCarAndUpload(file);
            return;
        }
        
        // Use the extracted upload function
        uploadSingleFile(file, carId);
    }
    
    function addTemporaryImageItem(data, fileName = '') {
        console.log('🖼️ ADD_IMAGE: Adding image', data.image_id, 'to gallery');
        
        // Remove "no images" message if it exists
        const noImagesMsg = document.getElementById('no-images-message');
        if (noImagesMsg) {
            noImagesMsg.remove();
        }
        
        // Show drag-drop info if it's hidden (for add page)
        const dragDropInfo = document.getElementById('drag-drop-info');
        if (dragDropInfo) {
            if (dragDropInfo.style.display === 'none' || window.getComputedStyle(dragDropInfo).display === 'none') {
                dragDropInfo.style.display = 'block';
            }
        }
        
        const imageItem = document.createElement('div');
        imageItem.className = 'image-item image-processing';
        imageItem.setAttribute('data-id', data.image_id);
        
        imageItem.innerHTML = `
            <div class="image-position-badge">${document.querySelectorAll('.image-item').length + 1}</div>
            <div class="drag-handle">
                <i class="fas fa-grip-vertical"></i>
            </div>
            <img src="${data.image_url}" alt="Vehicle image">
            <div class="processing-overlay">
                <i class="fas fa-spinner fa-spin"></i>
                <div>Processing...</div>
            </div>
            <button type="button" data-id="${data.image_id}" class="btn btn-danger btn-sm delete-image-btn" disabled>
                <i class="fas fa-trash me-1"></i>Processing...
            </button>
        `;
        
        if (sortableImagesContainer) {
            sortableImagesContainer.appendChild(imageItem);
            updateImageLimitText();
            console.log('✅ ADD_IMAGE: Image added to gallery, updated count');
        } else {
            console.error('❌ ADD_IMAGE: sortableImagesContainer not found!');
            console.error('❌ ADD_IMAGE: Looking for element with ID: sortable-images');
            const debugElement = document.getElementById('sortable-images');
            console.error('❌ ADD_IMAGE: getElementById result:', debugElement);
        }
        
        // Add delete functionality (will be enabled after processing)
        const deleteBtn = imageItem.querySelector('.delete-image-btn');
        deleteBtn.addEventListener('click', function() {
            handleImageDelete(this);
        });
    }
    
    function finishUpload() {
        // Update final progress
        uploadCurrentFile.textContent = `All ${totalUploads} images processed!`;
        uploadOverallProgress.textContent = '100%';
        overallProgressBar.style.width = '100%';
        currentFileStatus.innerHTML = '<i class="fas fa-check-circle"></i> Complete';
        currentFileStatus.className = 'file-status completed';
        
        // Hide progress after 3 seconds
        setTimeout(() => {
            uploadProgressContainer.style.display = 'none';
            overallProgressBar.style.width = '0%';
        }, 3000);
        
        showToast(`Successfully processed ${totalUploads} image${totalUploads !== 1 ? 's' : ''}!`);
    }
    
    function checkImageProcessingStatus(imageId, onComplete = null) {
        const checkInterval = setInterval(() => {
            fetch(`/ajax/check-image-status/${imageId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const imageItem = document.querySelector(`[data-id="${imageId}"]`);
                    if (!imageItem) {
                        clearInterval(checkInterval);
                        if (onComplete) onComplete();
                        return;
                    }
                    
                    if (data.processing_status === 'completed') {
                        // Update file status in progress area
                        if (currentFileStatus && currentFileName.textContent) {
                            currentFileStatus.innerHTML = '<i class="fas fa-check-circle"></i> Completed';
                            currentFileStatus.className = 'file-status completed';
                        }
                        
                        // Update image item
                        imageItem.className = 'image-item image-completed';
                        const processingOverlay = imageItem.querySelector('.processing-overlay');
                        if (processingOverlay) {
                            processingOverlay.remove();
                        }
                        
                        // Enable delete button
                        const deleteBtn = imageItem.querySelector('.delete-image-btn');
                        deleteBtn.disabled = false;
                        deleteBtn.innerHTML = '<i class="fas fa-trash me-1"></i>Delete';
                        
                        setTimeout(() => {
                            imageItem.className = 'image-item'; // Remove completed styling
                        }, 2000);
                        
                        clearInterval(checkInterval);
                        if (onComplete) onComplete();
                        
                    } else if (data.processing_status === 'error') {
                        // Update file status in progress area
                        if (currentFileStatus && currentFileName.textContent) {
                            currentFileStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i> Failed';
                            currentFileStatus.className = 'file-status error';
                        }
                        
                        imageItem.className = 'image-item image-error';
                        const processingOverlay = imageItem.querySelector('.processing-overlay');
                        if (processingOverlay) {
                            processingOverlay.innerHTML = `
                                <i class="fas fa-exclamation-triangle"></i>
                                <div>Processing Failed</div>
                            `;
                        }
                        
                        // Enable delete button to allow removal
                        const deleteBtn = imageItem.querySelector('.delete-image-btn');
                        deleteBtn.disabled = false;
                        deleteBtn.innerHTML = '<i class="fas fa-trash me-1"></i>Delete';
                        
                        showToast('Image processing failed', 'error');
                        clearInterval(checkInterval);
                        if (onComplete) onComplete();
                    }
                }
            })
            .catch(error => {
                console.error('Status check error:', error);
                clearInterval(checkInterval);
                if (onComplete) onComplete();
            });
        }, 2000); // Check every 2 seconds
        
        // Stop checking after 30 seconds (timeout)
        setTimeout(() => {
            clearInterval(checkInterval);
            if (onComplete) onComplete();
        }, 30000);
    }
    
    // Update the existing delete handler to work with new images
    function handleImageDelete(button) {
        const imgId = button.getAttribute("data-id");
        const imageItem = button.closest('.image-item');
        
        // Add loading state
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
        button.disabled = true;
        
        fetch(`/ajax/delete-car-image/${imgId}/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
                "X-Requested-With": "XMLHttpRequest"
            }
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                // Animate removal
                imageItem.style.transition = 'all 0.3s ease';
                imageItem.style.transform = 'scale(0)';
                imageItem.style.opacity = '0';
                
                setTimeout(() => {
                    imageItem.remove();
                    updateImageLimitText();
                    updatePositionBadges();
                    
                    // Check if no images left, show empty message
                    const remainingImages = document.querySelectorAll('#sortable-images .image-item');
                    if (remainingImages.length === 0) {
                        const noImagesMsg = document.createElement('div');
                        noImagesMsg.id = 'no-images-message';
                        noImagesMsg.className = 'col-12 text-center text-muted py-4';
                        noImagesMsg.innerHTML = `
                            <i class="fas fa-images" style="font-size: 3rem; opacity: 0.3;"></i>
                            <div class="mt-2">No additional images uploaded</div>
                        `;
                        sortableImagesContainer.appendChild(noImagesMsg);
                    }
                }, 300);
                
                showToast('Image deleted successfully');
            } else {
                showToast('Failed to delete image', 'error');
                button.innerHTML = '<i class="fas fa-trash me-1"></i>Delete';
                button.disabled = false;
            }
        })
        .catch(err => {
            console.error("AJAX Delete Error:", err);
            showToast('Error deleting image', 'error');
            button.innerHTML = '<i class="fas fa-trash me-1"></i>Delete';
            button.disabled = false;
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}
