{% extends 'frontend/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{{ car.brand.name }} {{ car.model_name.name }} - AUTO DINERO Macedonia{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --primary-red: #ff8c00;
    --primary-blue: #1D3557;
    --light-gray: #F8F9FA;
    --dark-gray: #212529;
    --medium-gray: #6C757D;
    --white: #FFFFFF;
    --shadow: 0 4px 20px rgba(0,0,0,0.1);
    --shadow-hover: 0 8px 30px rgba(0,0,0,0.15);
  }

  body {
    font-family: 'Inter', sans-serif;
    background: var(--light-gray);
  }

  /* Header Section */
  .detail-header {
    background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-red) 100%);
    color: var(--white);
    padding: 40px 0;
    margin-bottom: 30px;
  }

  .breadcrumb {
    background: none;
    padding: 0;
    margin-bottom: 20px;
  }

  .breadcrumb-item + .breadcrumb-item::before {
    content: "›";
    color: rgba(255,255,255,0.7);
  }

  .breadcrumb-item a {
    color: rgba(255,255,255,0.9);
    text-decoration: none;
  }

  .breadcrumb-item.active {
    color: var(--white);
  }

  .back-btn {
    display: inline-flex;
    align-items: center;
    background: rgba(255,255,255,0.2);
    color: var(--white);
    padding: 10px 20px;
    border-radius: 25px;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s ease;
    border: 1px solid rgba(255,255,255,0.3);
  }

  .back-btn:hover {
    background: rgba(255,255,255,0.3);
    color: var(--white);
    transform: translateX(-3px);
    text-decoration: none;
  }

  .back-btn:focus {
    outline: none !important;
    border: none !important;
    box-shadow: none !important;
  }

  .detail-title {
    font-family: 'Poppins', sans-serif;
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 10px;
  }

  .detail-subtitle {
    font-size: 1.1rem;
    opacity: 0.9;
  }

  /* Main Content */
  .detail-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 15px;
  }
  
  @media (max-width: 576px) {
    .detail-grid {
      gap: 10px;
    }
    
    .detail-container {
      padding: 0 10px;
    }
    
    .detail-title {
      font-size: 1.5rem;
    }
    
    .main-image {
      padding-bottom: 65%; /* Even taller for very small screens */
      max-height: 250px;
      margin-bottom: 15px;
    }
    
    .image-gallery,
    .car-info,
    .specifications-section,
    .equipment-section {
      padding: 15px;
      margin-bottom: 15px;
    }
    
    .car-price {
      font-size: 1.6rem;
    }
    
    .carousel-nav {
      width: 35px;
      height: 35px;
      font-size: 0.9rem;
    }
    
    .carousel-nav.prev {
      left: 8px;
    }
    
    .carousel-nav.next {
      right: 8px;
    }
    
    .image-badge {
      padding: 3px 6px;
      border-radius: 12px;
      font-size: 0.6rem;
      top: 15px;
      left: 15px;
    }
    
    .thumbnails {
      gap: 6px;
    }
    
    .thumbnail {
      width: 50px;
      height: 38px;
    }
    
    .specs-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }
  }

  /* Extra small mobile devices */
  @media (max-width: 400px) {
    .specs-grid {
      gap: 10px;
    }
    
    .spec-card {
      padding: 12px 8px;
    }
    
    .spec-card-title {
      font-size: 0.85rem;
      line-height: 1.2;
      word-wrap: break-word;
    }
    
    .spec-card-value {
      font-size: 0.7rem;
    }
    
    .spec-card-icon img {
      width: 28px;
      height: 28px;
    }
  }

  @media (max-width: 768px) {
    .spec-card {
      padding: 15px 10px;
      min-width: 0; /* Allow flex shrinking */
    }
    
    .spec-card-icon {
      width: 54px;
      height: 54px;
      font-size: 1.2rem;
      margin-bottom: 10px;
    }
    
    .spec-card-title {
      font-size: 1rem;
    }
    
    .spec-card-value {
      font-size: 0.8rem;
    }
    
    .equipment-item {
      padding: 12px 15px;
      font-size: 0.9rem;
    }
    
    /* Additional mobile optimization */
    .spec-item {
      padding: 12px 0;
    }
    
    .contact-btn {
      padding: 12px 20px;
      font-size: 0.95rem;
    }
    
    /* Additional force for very small screens */
    .detail-grid {
      display: flex !important;
      flex-direction: column !important;
      gap: 15px;
    }
    
    .detail-grid > .image-gallery,
    .detail-grid > .car-info {
      width: 100% !important;
      max-width: 100% !important;
      min-width: 0 !important;
      flex: none !important;
    }
  }

  .detail-grid {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 10px;
    margin-bottom: 40px;
    min-height: 0; /* Allow grid items to shrink below their content size */
    align-items: start; /* Prevent stretching */
  }
  
  /* Force single column on all mobile and tablet screens */
  @media (max-width: 1350px) {
    .detail-grid {
      display: flex !important;
      flex-direction: column !important;
      gap: 10px;
    }
    
    .image-gallery,
    .car-info {
      width: 100% !important;
      max-width: 100% !important;
      flex: none !important;
    }
  }

  /* Image Gallery */
  .image-gallery {
    background: var(--white);
    border-radius: 16px;
    padding: 30px;
    box-shadow: var(--shadow);
  }

  .main-image {
    position: relative;
    margin-bottom: 20px;
    border-radius: 12px;
    overflow: hidden;
    background: #f8f9fa;
    width: 100%;
    height: 0;
    padding-bottom: 60%; /* 16:10 aspect ratio */
    max-height: 500px;
    border: 1px solid #e9ecef;
  }

  .main-image img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
    background: #f8f9fa;
    transition: transform 0.3s ease;
  }

  .image-badge {
    position: absolute;
    top: 20px;
    left: 20px;
    background: var(--primary-red);
    color: var(--white);
    padding: 5px 10px;
    border-radius: 15px;
    font-weight: 600;
    font-size: 0.75rem;
  }

  .thumbnails {
    display: flex;
    gap: 10px;
    overflow-x: auto;
    padding: 10px 0;
  }

  .thumbnail {
    width: 80px;
    height: 60px;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.3s ease;
    flex-shrink: 0;
    background: #f8f9fa;
  }

  .thumbnail:hover,
  .thumbnail.active {
    border-color: var(--primary-red);
    transform: scale(1.05);
  }

  .thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    background: #f8f9fa;
  }

  /* Carousel Navigation */
  .carousel-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 50px;
    height: 50px;
    background: var(--primary-red);
    border: none;
    border-radius: 50%;
    color: var(--white);
    font-size: 1.2rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    box-shadow: var(--shadow);
  }

  .carousel-nav:hover {
    background: #e67a00;
    transform: translateY(-50%) scale(1.1);
    box-shadow: var(--shadow-hover);
  }

  .carousel-nav.prev {
    left: 15px;
  }

  .carousel-nav.next {
    right: 15px;
  }

  .carousel-nav i {
    color: var(--white);
  }

  /* Car Info */
  .car-info {
    background: var(--white);
    border-radius: 16px;
    padding: 30px;
    box-shadow: var(--shadow);
    height: fit-content;
  }

  .product-count-view {
    background: var(--light-gray);
    padding: 10px 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
    color: var(--medium-gray);
    font-weight: 500;
  }

  .product-count-view i {
    color: var(--primary-red);
    font-size: 1rem;
    animation: blink 2s infinite;
  }

  @keyframes blink {
    0%, 50% { opacity: 1; }
    25% { opacity: 0.3; }
  }

  .product-count-view span {
    color: var(--primary-red);
    font-weight: 600;
  }

  .car-price {
    font-family: 'Poppins', sans-serif;
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--primary-red);
    margin-bottom: 20px;
  }

  .price-label {
    font-size: 0.9rem;
    color: var(--medium-gray);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 5px;
  }

  .quick-specs {
    margin-bottom: 30px;
  }

  .spec-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 0;
    border-bottom: 1px solid #F1F3F4;
  }

  .spec-item:last-child {
    border-bottom: none;
  }

  .spec-label {
    font-weight: 500;
    color: var(--medium-gray);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .spec-value {
    font-weight: 600;
    color: var(--dark-gray);
  }

  .spec-icon {
    width: 20px;
    height: 20px;
    color: var(--primary-red);
  }

  .contact-section {
    background: var(--light-gray);
    border-radius: 12px;
    padding: 25px;
  }

  .contact-title {
    font-family: 'Poppins', sans-serif;
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 15px;
    color: var(--dark-gray);
  }

  .contact-btn {
    background: var(--primary-red);
    color: var(--white);
    border: none;
    padding: 15px 25px;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    display: inline-block;
    width: 100%;
    text-align: center;
    margin-bottom: 10px;
    transition: all 0.3s ease;
  }

  .contact-btn:hover {
    background: #e67a00;
    color: var(--white);
    transform: translateY(-2px);
  }

  .contact-btn.secondary {
    background: transparent;
    color: var(--primary-blue);
    border: 2px solid var(--primary-blue);
  }

  .contact-btn.secondary:hover {
    background: var(--primary-blue);
    color: var(--white);
  }

  /* Specifications Section */
  .specifications-section {
    background: var(--white);
    border-radius: 16px;
    padding: 40px;
    margin-bottom: 30px;
    box-shadow: var(--shadow);
  }

  .section-title {
    font-family: 'Poppins', sans-serif;
    font-size: 2rem;
    font-weight: 700;
    color: var(--dark-gray);
    margin-bottom: 30px;
    text-align: center;
  }

  .specs-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 25px;
  }

  .spec-card {
    text-align: center;
    padding: 25px;
    border: 1px solid #F1F3F4;
    border-radius: 12px;
    transition: all 0.3s ease;
  }

  .spec-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow);
  }

  .spec-card-icon {
    width: 67px;
    height: 67px;
    background: var(--primary-red);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 15px;
    color: var(--white);
    font-size: 1.5rem;
    padding: 10px;
  }

  .spec-card-icon img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    filter: brightness(0) invert(1);
  }

  .spec-card-title {
    font-weight: 600;
    font-size: 1.1rem;
    color: var(--dark-gray);
    margin-bottom: 5px;
  }

  .spec-card-value {
    color: var(--medium-gray);
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* Equipment Section */
  .equipment-section {
    background: var(--white);
    border-radius: 16px;
    padding: 40px;
    box-shadow: var(--shadow);
  }

  .equipment-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 15px;
  }

  .equipment-item {
    background: var(--light-gray);
    padding: 15px 20px;
    border-radius: 8px;
    font-weight: 500;
    color: var(--dark-gray);
    display: flex;
    align-items: center;
    gap: 10px;
    transition: all 0.3s ease;
  }

  /* Hover effects only for non-touch devices */
  @media (hover: hover) and (pointer: fine) {
    .equipment-item:hover {
      background: var(--primary-red);
      color: var(--white);
    }

    .equipment-item:hover .equipment-icon {
      color: var(--white);
    }
  }

  .equipment-icon {
    color: var(--primary-red);
    font-size: 1.1rem;
  }

  /* Touch feedback for mobile devices */
  @media (hover: none) and (pointer: coarse) {
    .equipment-item.touch-active {
      background: var(--primary-red);
      color: var(--white);
    }

    .equipment-item.touch-active .equipment-icon {
      color: var(--white);
    }
  }

  /* Responsive Design */
  @media (max-width: 992px) {
    .detail-grid {
      grid-template-columns: 1fr;
      gap: 30px;
    }
    
    .detail-title {
      font-size: 2rem;
    }
    
    .car-price {
      font-size: 2rem;
    }
    
    .specs-grid {
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: repeat(4, 1fr);
      gap: 15px;
    }
    
    .main-image {
      padding-bottom: 56.25%; /* 16:9 aspect ratio for tablets */
      max-height: 400px;
    }
  }

  @media (max-width: 768px) {
    .detail-grid {
      gap: 10px;
    }
    
    .detail-title {
      font-size: 1.8rem;
    }
    
    .main-image {
      padding-bottom: 60%; /* Slightly taller for mobile */
      max-height: 300px;
    }
    
    .carousel-nav {
      width: 40px;
      height: 40px;
      font-size: 1rem;
    }
    
    .carousel-nav.prev {
      left: 10px;
    }
    
    .carousel-nav.next {
      right: 10px;
    }
    
    .image-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      top: 15px;
      left: 15px;
    }
    
    .equipment-grid {
      grid-template-columns: 1fr;
    }
    
    .image-gallery,
    .car-info,
    .specifications-section,
    .equipment-section {
      padding: 20px;
    }
    
    .thumbnails {
      padding: 5px 0;
      gap: 8px;
      justify-content: center;
    }
    
    .thumbnail {
      width: 60px;
      height: 45px;
    }
    
    .car-price {
      font-size: 1.8rem;
    }
    
    .detail-container {
      padding: 0 10px;
    }
    
    .vehicles-header {
      padding: 30px 0;
    }
    
    /* Ensure proper stacking order on mobile */
    .detail-grid {
      display: flex !important;
      flex-direction: column !important;
      gap: 10px;
    }
    
    .detail-grid > * {
      width: 100% !important;
      max-width: 100% !important;
      flex: none !important;
      box-sizing: border-box;
    }
    
    .image-gallery {
      margin-bottom: 0 !important;
    }
    
    .car-info {
      margin-top: 0 !important;
    }
  }

  /* Image Popup Modal */
  .image-popup {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.95);
    z-index: 10000;
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(5px);
    animation: fadeIn 0.3s ease-in-out;
    padding: 20px;
    box-sizing: border-box;
  }

  .image-popup.show {
    display: flex;
  }

  .image-popup-content {
    position: relative;
    max-width: 90vw;
    max-height: 90vh;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    animation: zoomIn 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    background: #000;
  }

  .image-popup img {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    object-fit: contain;
    display: block;
    margin: 0 auto;
  }

  .image-popup-close {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 50px;
    height: 50px;
    background: rgba(0, 0, 0, 0.7);
    border: none;
    border-radius: 50%;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1;
  }

  .image-popup-close:hover {
    background: rgba(255, 140, 0, 0.8);
    transform: scale(1.1);
  }

  .image-popup-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 60px;
    height: 60px;
    background: var(--primary-red);
    border: none;
    border-radius: 50%;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10001;
    box-shadow: 0 4px 20px rgba(255, 140, 0, 0.4);
  }

  .image-popup-nav:hover {
    background: #e67a00;
    transform: translateY(-50%) scale(1.1);
    box-shadow: 0 6px 30px rgba(255, 140, 0, 0.6);
  }

  .image-popup-nav.prev {
    left: 20px;
  }

  .image-popup-nav.next {
    right: 20px;
  }

  .image-popup-info {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
    color: white;
    padding: 30px 20px 20px;
    text-align: center;
  }

  .image-popup-counter {
    font-size: 0.9rem;
    opacity: 0.8;
    margin-bottom: 5px;
  }

  .image-popup-title {
    font-size: 1.1rem;
    font-weight: 600;
  }

  /* Open button for main image */
  .main-image {
    position: relative;
  }

  .open-popup-btn {
    position: absolute;
    bottom: 15px;
    right: 15px;
    background: var(--primary-red);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 5;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .main-image:hover .open-popup-btn {
    opacity: 1;
    visibility: visible;
  }

  .open-popup-btn:hover {
    background: #e67a00;
    transform: translateY(-2px);
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes zoomIn {
    from { 
      opacity: 0;
      transform: scale(0.8);
    }
    to { 
      opacity: 1;
      transform: scale(1);
    }
  }

  @media (max-width: 768px) {
    .image-popup {
      padding: 10px;
    }

    .image-popup-content {
      max-width: 95vw;
      max-height: 85vh;
      border-radius: 12px;
    }

    .image-popup-close,
    .image-popup-nav {
      width: 50px;
      height: 50px;
      font-size: 1.3rem;
    }

    .image-popup-close {
      top: 15px;
      right: 15px;
    }

    .image-popup-nav.prev {
      left: 15px;
    }

    .image-popup-nav.next {
      right: 15px;
    }

    .image-popup-info {
      padding: 20px 15px 15px;
    }

    .image-popup-title {
      font-size: 1rem;
    }

    .open-popup-btn {
      padding: 6px 12px;
      font-size: 0.8rem;
      bottom: 12px;
      right: 12px;
    }
  }

  @media (max-width: 480px) {
    .image-popup {
      padding: 5px;
    }

    .image-popup-content {
      max-width: 98vw;
      max-height: 80vh;
      border-radius: 8px;
    }

    .image-popup-nav {
      width: 45px;
      height: 45px;
      font-size: 1.2rem;
    }
    
    .image-popup-nav.prev {
      left: 10px;
    }

    .image-popup-nav.next {
      right: 10px;
    }
    
    .open-popup-btn {
      padding: 5px 10px;
      font-size: 0.75rem;
      bottom: 10px;
      right: 10px;
    }
  }

  /* Recommended Cars Section */
  .recommended-section {
    background: var(--white);
    border-radius: 16px;
    padding: 40px;
    margin-bottom: 30px;
    box-shadow: var(--shadow);
  }

  .section-subtitle {
    text-align: center;
    color: var(--medium-gray);
    font-size: 1.1rem;
    margin-bottom: 40px;
    margin-top: -10px;
  }

  .recommended-carousel-container {
    position: relative;
    margin: 0 -20px; /* Expand outside container */
  }

  .recommended-carousel-wrapper {
    overflow: hidden;
    padding: 20px 80px; /* Proper padding for arrows */
    margin: 0 20px; /* Restore container margins */
  }

  .recommended-carousel {
    display: flex;
    gap: 20px;
    transition: transform 0.5s ease-in-out;
  }

  .recommended-card {
    flex: 0 0 300px;
    background: var(--white);
    border-radius: 16px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
    overflow: hidden;
  }

  .recommended-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 35px rgba(255, 140, 0, 0.15);
  }

  .recommended-link {
    text-decoration: none;
    color: inherit;
    display: block;
  }

  .recommended-link:hover {
    text-decoration: none;
    color: inherit;
  }

  .recommended-image {
    position: relative;
    width: 100%;
    height: 200px;
    overflow: hidden;
  }

  .recommended-image img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    transition: transform 0.3s ease;
  }

  .recommended-card:hover .recommended-image img {
    transform: scale(1.05);
  }

  .recommended-badge {
    position: absolute;
    top: 12px;
    left: 12px;
    background: var(--primary-red);
    color: var(--white);
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
  }


  .recommended-content {
    padding: 20px;
  }

  .recommended-title {
    font-family: 'Poppins', sans-serif;
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--dark-gray);
    margin-bottom: 8px;
    line-height: 1.3;
  }

  .recommended-year {
    color: var(--medium-gray);
    font-size: 0.9rem;
    margin-bottom: 12px;
  }

  .recommended-specs {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
  }

  .recommended-specs .spec-item {
    display: flex;
    align-items: center;
    gap: 5px;
    color: var(--medium-gray);
    font-size: 0.85rem;
  }

  .recommended-specs .spec-item i {
    color: var(--primary-red);
    font-size: 0.8rem;
  }

  .recommended-price {
    font-family: 'Poppins', sans-serif;
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--primary-red);
  }

  /* Carousel Navigation */
  .recommended-nav-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 55px;
    height: 55px;
    background: var(--primary-red);
    border: none;
    border-radius: 50%;
    color: var(--white);
    font-size: 1.3rem;
    cursor: pointer;
    z-index: 15;
    transition: all 0.3s ease;
    box-shadow: 0 4px 20px rgba(255, 140, 0, 0.4);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .recommended-nav-btn:hover {
    background: #e67a00;
    transform: translateY(-50%) scale(1.1);
    box-shadow: 0 6px 30px rgba(255, 140, 0, 0.6);
  }

  .recommended-nav-btn.prev {
    left: 20px;
  }

  .recommended-nav-btn.next {
    right: 20px;
  }


  /* Carousel Indicators */
  .recommended-indicators {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-top: 30px;
  }

  .indicator-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #DEE2E6;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .indicator-dot.active {
    background: var(--primary-red);
  }

  .indicator-dot:hover {
    background: var(--primary-red);
    transform: scale(1.2);
  }

  /* Responsive Design for Recommended Section */
  @media (max-width: 1200px) {
    .recommended-card {
      flex: 0 0 280px;
    }
  }

  @media (max-width: 992px) {
    .recommended-section {
      padding: 30px 15px;
    }
    
    .recommended-card {
      flex: 0 0 280px;
    }
    
    .recommended-carousel {
      gap: 15px;
    }
    
    .recommended-carousel-wrapper {
      padding: 20px 70px;
    }
    
    .recommended-nav-btn {
      width: 50px;
      height: 50px;
      font-size: 1.2rem;
    }
  }

  @media (max-width: 768px) {
    .recommended-section {
      padding: 25px 10px;
    }
    
    .recommended-card {
      flex: 0 0 260px;
    }
    
    .recommended-carousel-wrapper {
      padding: 20px 60px;
    }
    
    .recommended-nav-btn {
      width: 45px;
      height: 45px;
      font-size: 1.1rem;
    }
    
    .recommended-nav-btn.prev {
      left: 15px;
    }
    
    .recommended-nav-btn.next {
      right: 15px;
    }
    
    .recommended-image {
      height: 160px;
    }
    
    .recommended-content {
      padding: 15px;
    }
    
    .recommended-title {
      font-size: 1.1rem;
    }
    
    .recommended-price {
      font-size: 1.2rem;
    }
  }

  @media (max-width: 576px) {
    .recommended-card {
      flex: 0 0 240px;
    }
    
    .recommended-carousel-wrapper {
      padding: 20px 50px;
    }
    
    .recommended-nav-btn {
      width: 42px;
      height: 42px;
      font-size: 1rem;
    }
    
    .recommended-nav-btn.prev {
      left: 10px;
    }
    
    .recommended-nav-btn.next {
      right: 10px;
    }
    
    .recommended-image {
      height: 140px;
    }
    
    .section-title {
      font-size: 1.6rem;
    }
    
    .section-subtitle {
      font-size: 1rem;
    }
  }

  /* Floating Back Button */
  .floating-back-btn {
    position: fixed;
    top: 20px;
    left: 20px;
    background: var(--primary-red);
    color: var(--white);
    border: none;
    border-radius: 25px;
    padding: 12px 20px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(255, 140, 0, 0.4);
    z-index: 9998;
    opacity: 0;
    visibility: hidden;
    transform: translateX(-20px);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    text-decoration: none;
    white-space: nowrap;
  }

  .floating-back-btn.show {
    opacity: 1;
    visibility: visible;
    transform: translateX(0);
  }

  .floating-back-btn:hover {
    background: #e67a00;
    color: var(--white);
    transform: translateX(0) scale(1.1);
    box-shadow: 0 6px 30px rgba(255, 140, 0, 0.6);
    text-decoration: none;
  }

  .floating-back-btn:active {
    transform: translateX(0) scale(0.95);
  }

  .floating-back-btn:focus {
    outline: none !important;
    border: none !important;
    box-shadow: 0 6px 30px rgba(255, 140, 0, 0.6) !important;
  }

  @media (max-width: 768px) {
    .floating-back-btn {
      padding: 10px 16px;
      font-size: 0.9rem;
      top: 15px;
      left: 15px;
      gap: 6px;
    }
  }
  
  @media (max-width: 480px) {
    .floating-back-btn {
      padding: 8px 12px;
      font-size: 0.85rem;
      gap: 4px;
    }
  }
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<section class="detail-header">
  <div class="container">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'frontend_index' %}">{% trans "Дома" %}</a></li>
        <li class="breadcrumb-item">
          {% if request.GET.back == 'vehicles' %}
            <a href="{% url 'frontend_vehicles' %}{% if request.GET.page or request.GET.brand or request.GET.model_name or request.GET.transmission or request.GET.vehicle_body or request.GET.fuel or request.GET.color or request.GET.for_beginners or request.GET.price_from or request.GET.price_to or request.GET.year_from or request.GET.sort_price or request.GET.sort_mileage or request.GET.sort_year %}?{% if request.GET.page %}page={{ request.GET.page }}&{% endif %}{% if request.GET.brand %}brand={{ request.GET.brand }}&{% endif %}{% if request.GET.model_name %}model_name={{ request.GET.model_name }}&{% endif %}{% if request.GET.transmission %}transmission={{ request.GET.transmission }}&{% endif %}{% if request.GET.vehicle_body %}vehicle_body={{ request.GET.vehicle_body }}&{% endif %}{% if request.GET.fuel %}fuel={{ request.GET.fuel }}&{% endif %}{% if request.GET.color %}color={{ request.GET.color }}&{% endif %}{% if request.GET.for_beginners %}for_beginners={{ request.GET.for_beginners }}&{% endif %}{% if request.GET.price_from %}price_from={{ request.GET.price_from }}&{% endif %}{% if request.GET.price_to %}price_to={{ request.GET.price_to }}&{% endif %}{% if request.GET.year_from %}year_from={{ request.GET.year_from }}&{% endif %}{% if request.GET.sort_price %}sort_price={{ request.GET.sort_price }}&{% endif %}{% if request.GET.sort_mileage %}sort_mileage={{ request.GET.sort_mileage }}&{% endif %}{% if request.GET.sort_year %}sort_year={{ request.GET.sort_year }}{% endif %}{% endif %}#car-{{ car.pk }}">{% trans "Возила" %}</a>
          {% else %}
            <a href="{% url 'frontend_vehicles' %}">{% trans "Возила" %}</a>
          {% endif %}
        </li>
        <li class="breadcrumb-item active">{{ car.brand.name }} {{ car.model_name.name }}</li>
      </ol>
    </nav>
    
    <!-- Back Button for Mobile -->
    {% if request.GET.back == 'vehicles' %}
    <div class="mb-3">
      <a href="{% url 'frontend_vehicles' %}{% if request.GET.page or request.GET.brand or request.GET.model_name or request.GET.transmission or request.GET.vehicle_body or request.GET.fuel or request.GET.color or request.GET.for_beginners or request.GET.price_from or request.GET.price_to or request.GET.year_from or request.GET.sort_price or request.GET.sort_mileage or request.GET.sort_year %}?{% if request.GET.page %}page={{ request.GET.page }}&{% endif %}{% if request.GET.brand %}brand={{ request.GET.brand }}&{% endif %}{% if request.GET.model_name %}model_name={{ request.GET.model_name }}&{% endif %}{% if request.GET.transmission %}transmission={{ request.GET.transmission }}&{% endif %}{% if request.GET.vehicle_body %}vehicle_body={{ request.GET.vehicle_body }}&{% endif %}{% if request.GET.fuel %}fuel={{ request.GET.fuel }}&{% endif %}{% if request.GET.color %}color={{ request.GET.color }}&{% endif %}{% if request.GET.for_beginners %}for_beginners={{ request.GET.for_beginners }}&{% endif %}{% if request.GET.price_from %}price_from={{ request.GET.price_from }}&{% endif %}{% if request.GET.price_to %}price_to={{ request.GET.price_to }}&{% endif %}{% if request.GET.year_from %}year_from={{ request.GET.year_from }}&{% endif %}{% if request.GET.sort_price %}sort_price={{ request.GET.sort_price }}&{% endif %}{% if request.GET.sort_mileage %}sort_mileage={{ request.GET.sort_mileage }}&{% endif %}{% if request.GET.sort_year %}sort_year={{ request.GET.sort_year }}{% endif %}{% endif %}#car-{{ car.pk }}" class="back-btn">
        <i class="fas fa-arrow-left me-2"></i>{% trans "Назад кон листа" %}
      </a>
    </div>
    {% endif %}
    <h1 class="detail-title">{{ car.title }}</h1>
    <p class="detail-subtitle">{% trans "Детални информации за возилото" %}</p>
  </div>
</section>

<!-- Main Content -->
<div class="detail-container">
  <div class="detail-grid">
    <!-- Image Gallery -->
    <div class="image-gallery">
      <div class="main-image">
        <img src="{{ car.main_image.url }}" alt="{{ car.title }}" id="mainImage">
        <div class="image-badge">AUTO DINERO</div>
        <button class="open-popup-btn" onclick="openImagePopup('{{ car.main_image.url }}', 0)">
          <i class="fas fa-expand-alt"></i>
          {% trans "Отвори" %}
        </button>
        {% if car.images.all %}
        <button class="carousel-nav prev" onclick="navigateCarousel('prev')" type="button">
          <i class="fas fa-chevron-left"></i>
        </button>
        <button class="carousel-nav next" onclick="navigateCarousel('next')" type="button">
          <i class="fas fa-chevron-right"></i>
        </button>
        {% endif %}
      </div>
      
      {% if car.images.all %}
      <div class="thumbnails">
        <div class="thumbnail active" onclick="changeMainImage('{{ car.main_image.url }}', this)">
          <img src="{{ car.main_image.url }}" alt="Main">
        </div>
        {% for img in car.images.all %}
        <div class="thumbnail" onclick="changeMainImage('{{ img.image.url }}', this)">
          <img src="{{ img.image.url }}" alt="Gallery {{ forloop.counter }}">
        </div>
        {% endfor %}
      </div>
      {% endif %}
    </div>

    <!-- Car Info -->
    <div class="car-info">
      <div class="product-count-view" data-min="1" data-max="5" data-timeout="10000" data-id_product="{{ car.pk }}">
        <i class="fas fa-eye"></i>
        <span>{% load custom_tags %}{% random_number 1 5 %}</span>
        {% trans "луѓето го гледаат ова во моментов" %}
      </div>
      
      <div class="price-label">{% trans "Цена" %}</div>
      <div class="car-price">{{ car.display_price }}</div>
      
      <div class="quick-specs">
        <div class="spec-item">
          <div class="spec-label">
            <i class="fas fa-calendar-alt spec-icon"></i>
            {% trans "Година" %}
          </div>
          <div class="spec-value">{{ car.year }}</div>
        </div>
        <div class="spec-item">
          <div class="spec-label">
            <i class="fas fa-tachometer-alt spec-icon"></i>
            {% trans "Километража" %}
          </div>
          <div class="spec-value">{{ car.get_mileage_display }}</div>
        </div>
        <div class="spec-item">
          <div class="spec-label">
            <i class="fas fa-gas-pump spec-icon"></i>
            {% trans "Гориво" %}
          </div>
          <div class="spec-value">{{ car.get_fuel_type_display }}</div>
        </div>
        <div class="spec-item">
          <div class="spec-label">
            <i class="fas fa-cog spec-icon"></i>
            {% trans "Менувач" %}
          </div>
          <div class="spec-value">{{ car.get_transmission_display }}</div>
        </div>
        <div class="spec-item">
          <div class="spec-label">
            <i class="fas fa-car spec-icon"></i>
            {% trans "Каросерија" %}
          </div>
          <div class="spec-value">{{ car.get_body_type_display }}</div>
        </div>
      </div>

      <div class="contact-section">
        <h3 class="contact-title">{% trans "Заинтересирани сте?" %}</h3>
        <a href="tel:+38970123456" class="contact-btn">
          <i class="fas fa-phone me-2"></i>{% trans "Повикајте нас" %}
        </a>
        <a href="mailto:info@moeauto.mk?subject=Интерес за {{ car.title }}" class="contact-btn secondary">
          <i class="fas fa-envelope me-2"></i>{% trans "Испратете е-мејл" %}
        </a>
      </div>
    </div>
  </div>

  <!-- Detailed Specifications -->
  <div class="specifications-section">
    <h2 class="section-title">{% trans "Детални спецификации" %}</h2>
    <div class="specs-grid">
      <div class="spec-card">
        <div class="spec-card-icon">
          <img src="{% static 'car-engine.png' %}" alt="Моќност" loading="lazy" />
        </div>
        <div class="spec-card-title">{{ car.kilowatts }}kW ({{ car.horsepower }}hp)</div>
        <div class="spec-card-value">{% trans "МОЌНОСТ" %}</div>
      </div>
      <div class="spec-card">
        <div class="spec-card-icon">
          <img src="{% static 'license-plate.png' %}" alt="Регистрација" loading="lazy" />
        </div>
        <div class="spec-card-title">{{ car.get_registration_type_display }}</div>
        <div class="spec-card-value">{% trans "Регистрација" %}</div>
      </div>
      <div class="spec-card">
        <div class="spec-card-icon">
          <img src="{% static 'mileage.png' %}" alt="Километража" loading="lazy" />
        </div>
        <div class="spec-card-title">{{ car.get_mileage_display }}</div>
        <div class="spec-card-value">{% trans "Километража" %}</div>
      </div>
      <div class="spec-card">
        <div class="spec-card-icon">
          <img src="{% static 'car-seat.png' %}" alt="Број на седишта" loading="lazy" />
        </div>
        <div class="spec-card-title">{{ car.get_seats_display }}</div>
        <div class="spec-card-value">{% trans "Број на седишта" %}</div>
      </div>
      <div class="spec-card">
        <div class="spec-card-icon">
          <img src="{% static 'manual-transmission.png' %}" alt="Менувач" loading="lazy" />
        </div>
        <div class="spec-card-title">{{ car.get_transmission_display }}</div>
        <div class="spec-card-value">{% trans "Менувач" %}</div>
      </div>
      <div class="spec-card">
        <div class="spec-card-icon">
          <img src="{% static 'car-engine.png' %}" alt="Мотор" loading="lazy" />
        </div>
        <div class="spec-card-title">{{ car.engine_capacity }} cm³</div>
        <div class="spec-card-value">{% trans "Мотор" %}</div>
      </div>
      <div class="spec-card">
        <div class="spec-card-icon">
          <img src="{% static 'palette.png' %}" alt="Боја" loading="lazy" />
        </div>
        <div class="spec-card-title">{{ car.get_color_display }}</div>
        <div class="spec-card-value">{% trans "Боја" %}</div>
      </div>
      <div class="spec-card">
        <div class="spec-card-icon">
          <img src="{% static 'sedan.png' %}" alt="Каросерија" loading="lazy" />
        </div>
        <div class="spec-card-title">{{ car.get_body_type_display }}</div>
        <div class="spec-card-value">{% trans "Каросерија" %}</div>
      </div>
    </div>
  </div>

  <!-- Equipment -->
  {% if car.equipment.exists %}
  <div class="equipment-section">
    <h2 class="section-title">{% trans "Опрема" %}</h2>
    <div class="equipment-grid">
      {% for equipment in car.equipment.all %}
      <div class="equipment-item">
        <i class="fas fa-check equipment-icon"></i>
        {{ equipment.name }}
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Recommended Cars Section -->
  {% if recommended_cars %}
  <div class="recommended-section">
    <h2 class="section-title">{% trans "Препорачани возила" %}</h2>
    <p class="section-subtitle">{% trans "Слични возила што можеби ќе ве интересираат" %}</p>
    
    <div class="recommended-carousel-container">
      <button class="recommended-nav-btn prev" id="recPrevBtn" onclick="slideRecommended(-1)">
        <i class="fas fa-chevron-left"></i>
      </button>
      <button class="recommended-nav-btn next" id="recNextBtn" onclick="slideRecommended(1)">
        <i class="fas fa-chevron-right"></i>
      </button>
      
      <div class="recommended-carousel-wrapper">
        <div class="recommended-carousel" id="recommendedCarousel">
        {% for rec_car in recommended_cars %}
        <div class="recommended-card">
          <a href="{% url 'frontend_vehicle_detail' rec_car.pk %}?back=vehicles{% if request.GET.page %}&page={{ request.GET.page }}{% endif %}{% if request.GET.brand %}&brand={{ request.GET.brand }}{% endif %}{% if request.GET.model_name %}&model_name={{ request.GET.model_name }}{% endif %}{% if request.GET.transmission %}&transmission={{ request.GET.transmission }}{% endif %}{% if request.GET.vehicle_body %}&vehicle_body={{ request.GET.vehicle_body }}{% endif %}{% if request.GET.fuel %}&fuel={{ request.GET.fuel }}{% endif %}{% if request.GET.color %}&color={{ request.GET.color }}{% endif %}{% if request.GET.for_beginners %}&for_beginners={{ request.GET.for_beginners }}{% endif %}{% if request.GET.price_from %}&price_from={{ request.GET.price_from }}{% endif %}{% if request.GET.price_to %}&price_to={{ request.GET.price_to }}{% endif %}{% if request.GET.year_from %}&year_from={{ request.GET.year_from }}{% endif %}{% if request.GET.sort_price %}&sort_price={{ request.GET.sort_price }}{% endif %}{% if request.GET.sort_mileage %}&sort_mileage={{ request.GET.sort_mileage }}{% endif %}{% if request.GET.sort_year %}&sort_year={{ request.GET.sort_year }}{% endif %}" class="recommended-link">
            <div class="recommended-image">
              <img src="{{ rec_car.main_image.url }}" alt="{{ rec_car.title }}" loading="lazy">
              <div class="recommended-badge">AUTO DINERO</div>
            </div>
            <div class="recommended-content">
              <h4 class="recommended-title">{{ rec_car.brand.name }} {{ rec_car.model_name.name }}</h4>
              <p class="recommended-year">{{ rec_car.year }} • {{ rec_car.get_mileage_display }}</p>
              <div class="recommended-specs">
                <span class="spec-item">
                  <i class="fas fa-gas-pump"></i>
                  {{ rec_car.get_fuel_type_display }}
                </span>
                <span class="spec-item">
                  <i class="fas fa-cog"></i>
                  {{ rec_car.get_transmission_display }}
                </span>
              </div>
              <div class="recommended-price">{{ rec_car.display_price }}</div>
            </div>
          </a>
        </div>
        {% endfor %}
        </div>
      </div>
      
      <!-- Carousel dots/indicators -->
      <div class="recommended-indicators" id="recommendedIndicators"></div>
    </div>
  </div>
  {% endif %}
</div>

<!-- Floating Back Button -->
{% if request.GET.back == 'vehicles' %}
<a href="{% url 'frontend_vehicles' %}{% if request.GET.page or request.GET.brand or request.GET.model_name or request.GET.transmission or request.GET.vehicle_body or request.GET.fuel or request.GET.color or request.GET.for_beginners or request.GET.price_from or request.GET.price_to or request.GET.year_from or request.GET.sort_price or request.GET.sort_mileage or request.GET.sort_year %}?{% if request.GET.page %}page={{ request.GET.page }}&{% endif %}{% if request.GET.brand %}brand={{ request.GET.brand }}&{% endif %}{% if request.GET.model_name %}model_name={{ request.GET.model_name }}&{% endif %}{% if request.GET.transmission %}transmission={{ request.GET.transmission }}&{% endif %}{% if request.GET.vehicle_body %}vehicle_body={{ request.GET.vehicle_body }}&{% endif %}{% if request.GET.fuel %}fuel={{ request.GET.fuel }}&{% endif %}{% if request.GET.color %}color={{ request.GET.color }}&{% endif %}{% if request.GET.for_beginners %}for_beginners={{ request.GET.for_beginners }}&{% endif %}{% if request.GET.price_from %}price_from={{ request.GET.price_from }}&{% endif %}{% if request.GET.price_to %}price_to={{ request.GET.price_to }}&{% endif %}{% if request.GET.year_from %}year_from={{ request.GET.year_from }}&{% endif %}{% if request.GET.sort_price %}sort_price={{ request.GET.sort_price }}&{% endif %}{% if request.GET.sort_mileage %}sort_mileage={{ request.GET.sort_mileage }}&{% endif %}{% if request.GET.sort_year %}sort_year={{ request.GET.sort_year }}{% endif %}{% endif %}#car-{{ car.pk }}" class="floating-back-btn" id="floatingBackBtn">
  <i class="fas fa-arrow-left"></i>
  {% trans "Назад" %}
</a>
{% else %}
<a href="{% url 'frontend_vehicles' %}" class="floating-back-btn" id="floatingBackBtn">
  <i class="fas fa-arrow-left"></i>
  {% trans "Назад" %}
</a>
{% endif %}

<!-- Image Popup Modal -->
<div class="image-popup" id="imagePopup">
  <button class="image-popup-close" onclick="closeImagePopup()">
    <i class="fas fa-times"></i>
  </button>
  
  {% if car.images.all %}
  <button class="image-popup-nav prev" onclick="navigatePopup(-1)">
    <i class="fas fa-chevron-left"></i>
  </button>
  <button class="image-popup-nav next" onclick="navigatePopup(1)">
    <i class="fas fa-chevron-right"></i>
  </button>
  {% endif %}
  
  <div class="image-popup-content">
    <img id="popupImage" src="" alt="">
    <div class="image-popup-info">
      <div class="image-popup-counter" id="popupCounter"></div>
      <div class="image-popup-title">{{ car.title }}</div>
    </div>
  </div>
</div>

<script>
// Store all image sources for carousel navigation
const imageUrls = [
  '{{ car.main_image.url }}',
  {% for img in car.images.all %}'{{ img.image.url }}',{% endfor %}
];

let currentImageIndex = 0;

function changeMainImage(imageSrc, thumbnail) {
  // Update main image
  document.getElementById('mainImage').src = imageSrc;
  
  // Update current index
  currentImageIndex = imageUrls.indexOf(imageSrc);
  
  // Update active thumbnail
  document.querySelectorAll('.thumbnail').forEach(thumb => {
    thumb.classList.remove('active');
  });
  if (thumbnail) {
    thumbnail.classList.add('active');
  }
}

function navigateCarousel(direction) {
  if (imageUrls.length <= 1) return;
  
  if (direction === 'next') {
    currentImageIndex = (currentImageIndex + 1) % imageUrls.length;
  } else {
    currentImageIndex = (currentImageIndex - 1 + imageUrls.length) % imageUrls.length;
  }
  
  const newImageSrc = imageUrls[currentImageIndex];
  document.getElementById('mainImage').src = newImageSrc;
  
  // Update active thumbnail
  const thumbnails = document.querySelectorAll('.thumbnail');
  thumbnails.forEach(thumb => thumb.classList.remove('active'));
  if (thumbnails[currentImageIndex]) {
    thumbnails[currentImageIndex].classList.add('active');
  }
}

// Keyboard navigation
document.addEventListener('keydown', function(e) {
  if (e.key === 'ArrowLeft') {
    navigateCarousel('prev');
  } else if (e.key === 'ArrowRight') {
    navigateCarousel('next');
  }
});

// Touch/swipe support for mobile
let touchStartX = 0;
let touchEndX = 0;

const mainImage = document.getElementById('mainImage');
mainImage.addEventListener('touchstart', function(e) {
  touchStartX = e.changedTouches[0].screenX;
});

mainImage.addEventListener('touchend', function(e) {
  touchEndX = e.changedTouches[0].screenX;
  handleSwipe();
});

function handleSwipe() {
  const swipeThreshold = 50;
  const diff = touchStartX - touchEndX;
  
  if (Math.abs(diff) > swipeThreshold) {
    if (diff > 0) {
      navigateCarousel('next');
    } else {
      navigateCarousel('prev');
    }
  }
}

// Image Popup Functions
function openImagePopup(imageSrc, imageIndex = null) {
  const popup = document.getElementById('imagePopup');
  const popupImage = document.getElementById('popupImage');
  const popupCounter = document.getElementById('popupCounter');
  
  // Set current image index
  if (imageIndex !== null) {
    currentImageIndex = imageIndex;
  } else {
    currentImageIndex = imageUrls.indexOf(imageSrc);
  }
  
  // Set image source
  popupImage.src = imageSrc;
  
  // Update counter
  updatePopupCounter();
  
  // Show popup
  popup.classList.add('show');
  document.body.style.overflow = 'hidden'; // Prevent body scroll
}

function closeImagePopup() {
  const popup = document.getElementById('imagePopup');
  popup.classList.remove('show');
  document.body.style.overflow = ''; // Restore body scroll
}

function navigatePopup(direction) {
  if (imageUrls.length <= 1) return;
  
  currentImageIndex += direction;
  
  // Loop around
  if (currentImageIndex >= imageUrls.length) {
    currentImageIndex = 0;
  } else if (currentImageIndex < 0) {
    currentImageIndex = imageUrls.length - 1;
  }
  
  const popupImage = document.getElementById('popupImage');
  popupImage.src = imageUrls[currentImageIndex];
  updatePopupCounter();
}

function updatePopupCounter() {
  const popupCounter = document.getElementById('popupCounter');
  if (imageUrls.length > 1) {
    popupCounter.textContent = `${currentImageIndex + 1} / ${imageUrls.length}`;
  } else {
    popupCounter.textContent = '';
  }
}

// Floating Back Button is now controlled by the global navbar scroll logic in base.html

// Event Listeners for Image Popup
document.addEventListener('DOMContentLoaded', function() {
  // Floating back button is now controlled by base.html navbar scroll logic
  // Main image click removed - now handled by button only
  
  // Thumbnail clicks - removed popup functionality
  // Thumbnails now only change the main image via changeMainImage function
  
  // Close popup on background click
  document.getElementById('imagePopup').addEventListener('click', function(e) {
    if (e.target === this) {
      closeImagePopup();
    }
  });
  
  // Keyboard navigation for popup
  document.addEventListener('keydown', function(e) {
    const popup = document.getElementById('imagePopup');
    if (!popup.classList.contains('show')) return;
    
    if (e.key === 'Escape') {
      closeImagePopup();
    } else if (e.key === 'ArrowLeft') {
      navigatePopup(-1);
    } else if (e.key === 'ArrowRight') {
      navigatePopup(1);
    }
  });
});

// Recommended Cars Carousel
let recommendedCurrentSlide = 0;
let recommendedItemsPerSlide = 3;
let recommendedTotalItems = 0;
let recommendedTotalSlides = 0;

function initializeRecommendedCarousel() {
  const carousel = document.getElementById('recommendedCarousel');
  const indicators = document.getElementById('recommendedIndicators');
  const prevBtn = document.getElementById('recPrevBtn');
  const nextBtn = document.getElementById('recNextBtn');
  
  if (!carousel) return;
  
  const cards = carousel.querySelectorAll('.recommended-card');
  recommendedTotalItems = cards.length;
  
  // Calculate items per slide based on screen size
  updateItemsPerSlide();
  
  if (recommendedTotalItems <= recommendedItemsPerSlide) {
    // Hide navigation if all items fit in one slide
    if (prevBtn) prevBtn.style.display = 'none';
    if (nextBtn) nextBtn.style.display = 'none';
    indicators.style.display = 'none';
    return;
  } else {
    // Show navigation
    if (prevBtn) prevBtn.style.display = 'flex';
    if (nextBtn) nextBtn.style.display = 'flex';
    indicators.style.display = 'flex';
  }
  
  recommendedTotalSlides = Math.ceil(recommendedTotalItems / recommendedItemsPerSlide);
  
  // Reset to first slide when reinitializing
  recommendedCurrentSlide = 0;
  
  // Create indicators
  indicators.innerHTML = '';
  for (let i = 0; i < recommendedTotalSlides; i++) {
    const dot = document.createElement('div');
    dot.className = `indicator-dot ${i === 0 ? 'active' : ''}`;
    dot.onclick = () => goToRecommendedSlide(i);
    indicators.appendChild(dot);
  }
  
  updateRecommendedCarousel();
  updateRecommendedNavigation();
}

function updateItemsPerSlide() {
  const width = window.innerWidth;
  if (width <= 576) {
    recommendedItemsPerSlide = 1;
  } else if (width <= 992) {
    recommendedItemsPerSlide = 2;
  } else {
    recommendedItemsPerSlide = 3;
  }
}

function slideRecommended(direction) {
  let newSlide = recommendedCurrentSlide + direction;
  
  // Loop functionality
  if (newSlide < 0) {
    newSlide = recommendedTotalSlides - 1; // Go to last slide
  } else if (newSlide >= recommendedTotalSlides) {
    newSlide = 0; // Go to first slide
  }
  
  recommendedCurrentSlide = newSlide;
  updateRecommendedCarousel();
  updateRecommendedNavigation();
}

function goToRecommendedSlide(slideIndex) {
  recommendedCurrentSlide = slideIndex;
  updateRecommendedCarousel();
  updateRecommendedNavigation();
}

function updateRecommendedCarousel() {
  const carousel = document.getElementById('recommendedCarousel');
  if (!carousel) return;
  
  // Dynamic card width based on screen size
  let cardWidth, gap;
  const width = window.innerWidth;
  
  if (width <= 576) {
    cardWidth = 240;
    gap = 20;
  } else if (width <= 768) {
    cardWidth = 260;
    gap = 15;
  } else if (width <= 992) {
    cardWidth = 280;
    gap = 15;
  } else if (width <= 1200) {
    cardWidth = 280;
    gap = 20;
  } else {
    cardWidth = 300;
    gap = 20;
  }
  
  const offset = recommendedCurrentSlide * (cardWidth + gap) * recommendedItemsPerSlide;
  carousel.style.transform = `translateX(-${offset}px)`;
}

function updateRecommendedNavigation() {
  // Navigation buttons are never disabled now (loop functionality)
  const prevBtn = document.getElementById('recPrevBtn');
  const nextBtn = document.getElementById('recNextBtn');
  
  if (prevBtn) {
    prevBtn.disabled = false;
  }
  
  if (nextBtn) {
    nextBtn.disabled = false;
  }
  
  // Update indicators
  const indicators = document.querySelectorAll('.indicator-dot');
  indicators.forEach((dot, index) => {
    dot.classList.toggle('active', index === recommendedCurrentSlide);
  });
}

// Touch/swipe support for recommended carousel
let recTouchStartX = 0;
let recTouchEndX = 0;

function initializeRecommendedTouch() {
  const carousel = document.getElementById('recommendedCarousel');
  if (!carousel) return;
  
  carousel.addEventListener('touchstart', function(e) {
    recTouchStartX = e.changedTouches[0].screenX;
  }, { passive: true });

  carousel.addEventListener('touchend', function(e) {
    recTouchEndX = e.changedTouches[0].screenX;
    handleRecommendedSwipe();
  }, { passive: true });
}

function handleRecommendedSwipe() {
  const swipeThreshold = 50;
  const diff = recTouchStartX - recTouchEndX;
  
  if (Math.abs(diff) > swipeThreshold) {
    if (diff > 0) {
      slideRecommended(1); // Swipe left = next slide
    } else {
      slideRecommended(-1); // Swipe right = previous slide
    }
  }
}

// Handle window resize for recommended carousel
function handleRecommendedResize() {
  const oldItemsPerSlide = recommendedItemsPerSlide;
  updateItemsPerSlide();
  
  if (oldItemsPerSlide !== recommendedItemsPerSlide) {
    recommendedCurrentSlide = 0;
    initializeRecommendedCarousel();
  }
}

// View counter dynamic update function
function initializeViewCounter() {
  const viewCountElement = document.querySelector('.product-count-view span');
  if (!viewCountElement) return;
  
  let currentCount = parseInt(viewCountElement.textContent);
  
  function updateViewCount() {
    // Random change: -1, 0, or +1
    const change = Math.floor(Math.random() * 3) - 1; // -1, 0, or 1
    let newCount = currentCount + change;
    
    // Keep within 1-5 range
    if (newCount < 1) newCount = 1;
    if (newCount > 5) newCount = 5;
    
    currentCount = newCount;
    viewCountElement.textContent = currentCount;
    
    // Schedule next update (15-30 seconds)
    const nextUpdate = Math.random() * 15000 + 15000; // 15000-30000ms
    setTimeout(updateViewCount, nextUpdate);
  }
  
  // Start the first update cycle
  const initialDelay = Math.random() * 15000 + 15000; // 15-30 seconds
  setTimeout(updateViewCount, initialDelay);
}

// Handle touch events for equipment items to prevent sticky hover on mobile
document.addEventListener('DOMContentLoaded', function() {
  // Initialize view counter
  initializeViewCounter();
  
  // Initialize recommended carousel
  initializeRecommendedCarousel();
  initializeRecommendedTouch();
  
  // Handle window resize
  let resizeTimeout;
  window.addEventListener('resize', function() {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(handleRecommendedResize, 250);
  });
  
  const equipmentItems = document.querySelectorAll('.equipment-item');
  
  equipmentItems.forEach(item => {
    // Add touch feedback on touchstart
    item.addEventListener('touchstart', function() {
      // Remove touch-active class from all other items
      equipmentItems.forEach(otherItem => {
        if (otherItem !== this) {
          otherItem.classList.remove('touch-active');
        }
      });
      
      // Add touch-active class to current item
      this.classList.add('touch-active');
    }, { passive: true });
    
    // Remove touch feedback on touchend
    item.addEventListener('touchend', function() {
      // Remove the touch-active class immediately after touch ends
      setTimeout(() => {
        this.classList.remove('touch-active');
      }, 150); // Small delay for visual feedback
    }, { passive: true });
    
    // Also remove on touchcancel (when touch is interrupted)
    item.addEventListener('touchcancel', function() {
      this.classList.remove('touch-active');
    }, { passive: true });
  });
});
</script>
{% endblock %}
